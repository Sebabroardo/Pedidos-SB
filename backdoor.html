<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backdoor - Gestor de Locales/Usuarios</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAou7COlKKf0mJCnwEefntTKVGI2cxxJrU",
  authDomain: "santa-roti.firebaseapp.com",
  projectId: "santa-roti",
  storageBucket: "santa-roti.appspot.com",
  messagingSenderId: "66221970620",
  appId: "1:66221970620:web:53083ce7727ff85e6d2cb9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ELEMENTOS
const loginDiv = document.getElementById("loginDiv");
const dashboardDiv = document.getElementById("dashboardDiv");
const logoutBtn = document.getElementById("logoutBtn");
const welcomeMessage = document.getElementById("welcomeMessage");
const sidebar = document.getElementById("sidebar");

welcomeMessage.style.display = "none";

function showDashboard(user){
  loginDiv.style.display = "none";
  dashboardDiv.style.display = "flex";
  welcomeMessage.style.display = "block";
}

function showLogin(){
  dashboardDiv.style.display = "none";
  loginDiv.style.display = "flex";
  welcomeMessage.style.display = "none";
}

// --- AUTH ---
onAuthStateChanged(auth, (user) => {
  if(user) showDashboard(user);
  else showLogin();
});

document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById("loginForm");
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const rememberMe = document.getElementById("rememberMe").checked;

    try {
      await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);
      await signInWithEmailAndPassword(auth,email,password);
    } catch(err){
      alert("Error: "+err.message);
    }
  });

  logoutBtn.addEventListener("click", async ()=>{ try{ await signOut(auth); }catch(err){ alert("Error al cerrar sesi√≥n: "+err.message); } });

  const menuItems = document.querySelectorAll("#sidebarMenu ul li");
  menuItems.forEach(item => {
    item.addEventListener("click", async () => {
      menuItems.forEach(i => i.classList.remove("active"));
      item.classList.add("active");
      const section = item.getAttribute("data-section");

      if(section === "Crear Usuarios"){
        document.getElementById("mainContent").innerHTML = `
          <div class="user-page">
            <div id="userFormContainer" class="user-form">
              <h2>Creaci√≥n de Usuarios</h2>
              <div class="form-group">
                <label for="newUsername">Nombre de Usuario:</label>
                <input type="text" id="newUsername" placeholder="Ingrese nombre de usuario" required>
              </div>
              <div class="form-group">
                <label for="newPassword">Contrase√±a:</label>
                <input type="password" id="newPassword" placeholder="Ingrese contrase√±a" required>
              </div>
              <div class="form-group">
                <label for="newLocal">Nombre de Local:</label>
                <input type="text" id="newLocal" placeholder="Local asignado" required>
              </div>
              <button id="saveUserBtn">Guardar Usuario</button>
              <div id="userMessage"></div>
            </div>

            <div id="userListContainer" class="user-list">
              <h2>Usuarios Existentes</h2>
              <input type="text" id="searchUser" placeholder="Buscar usuario...">
              <div id="userGrid"></div>
            </div>
          </div>
        `;

        const saveUserBtn = document.getElementById("saveUserBtn");
        const saveUserHandler = async ()=>{
          const username = document.getElementById("newUsername").value.trim();
          const password = document.getElementById("newPassword").value.trim();
          const localName = document.getElementById("newLocal").value.trim();
          if(!username || !password || !localName){
            document.getElementById("userMessage").innerText="Completa todos los campos.";
            return;
          }
          try {
            await addDoc(collection(db,"Users"),{username,password,local:localName,createdAt:serverTimestamp()});
            document.getElementById("userMessage").innerText="Usuario creado correctamente.";
            document.getElementById("newUsername").value="";
            document.getElementById("newPassword").value="";
            document.getElementById("newLocal").value="";
            loadUsers();
          } catch(err){ document.getElementById("userMessage").innerText="Error al crear usuario: "+err.message; }
        };
        saveUserBtn.onclick = saveUserHandler;

        async function loadUsers(search=""){
          const userGrid = document.getElementById("userGrid");
          userGrid.innerHTML = "";
          let q = collection(db,"Users");
          if(search){ q = query(collection(db,"Users"),where("username", ">=", search), where("username","<=",search+"\uf8ff")); }
          const querySnapshot = await getDocs(q);
          querySnapshot.forEach(docSnap=>{
            const userData = docSnap.data();
            const date = userData.createdAt ? new Date(userData.createdAt.seconds*1000).toLocaleString() : "-";
            const userDiv = document.createElement("div");
            userDiv.classList.add("user-row");
            userDiv.innerHTML = `
              <span>${userData.username}</span>
              <span>${date}</span>
              <div class="user-actions">
                <button class="edit-btn">‚úèÔ∏è</button>
                <button class="delete-btn">üóëÔ∏è</button>
              </div>
            `;
            userDiv.querySelector(".delete-btn").addEventListener("click", async ()=>{
              if(confirm("¬øEliminar usuario?")){ await deleteDoc(doc(db,"Users",docSnap.id)); loadUsers(); }
            });
            userDiv.querySelector(".edit-btn").addEventListener("click", ()=>{
              document.getElementById("newUsername").value=userData.username;
              document.getElementById("newPassword").value=userData.password;
              document.getElementById("newLocal").value=userData.local;
              document.getElementById("userMessage").innerText="Editando usuario, guardar cambios.";
              saveUserBtn.onclick=async()=>{
                await updateDoc(doc(db,"Users",docSnap.id),{
                  username: document.getElementById("newUsername").value,
                  password: document.getElementById("newPassword").value,
                  local: document.getElementById("newLocal").value
                });
                document.getElementById("userMessage").innerText="Usuario actualizado correctamente.";
                loadUsers();
                document.getElementById("newUsername").value="";
                document.getElementById("newPassword").value="";
                document.getElementById("newLocal").value="";
                saveUserBtn.onclick=saveUserHandler;
              };
            });
            userGrid.appendChild(userDiv);
          });
        }

        const searchInput = document.getElementById("searchUser");
        searchInput.addEventListener("input", ()=>{ loadUsers(searchInput.value); });
        loadUsers();

      } else if(section === "Generador de Locales"){

        document.getElementById("mainContent").innerHTML = `
          <div class="user-page">
            <div id="localFormContainer" class="user-form">
              <h2>Generador de Locales</h2>
              <div class="form-group"><label for="localName">Nombre del Local:</label><input type="text" id="localName" placeholder="Nombre del local"></div>
              <div class="form-group"><label for="localInstagram">URL Instagram:</label><input type="text" id="localInstagram" placeholder="Instagram"></div>
              <div class="form-group"><label for="localLogo">URL Logo:</label><input type="text" id="localLogo" placeholder="Logo"></div>
              <div class="form-group"><label for="localBg">URL Imagen Fondo:</label><input type="text" id="localBg" placeholder="Imagen de fondo"></div>
              <button id="generateBtn">Generar HTML</button>
              <div id="localMessage"></div>
            </div>
            <iframe id="previewFrame" style="flex:1; width:100%; height:500px; border:1px solid #ccc; border-radius:8px;"></iframe>
          </div>
        `;

        const generateBtn = document.getElementById("generateBtn");
        const previewFrame = document.getElementById("previewFrame");

        async function fetchIndexHTML(){ 
          const res = await fetch("Index.html"); 
          return await res.text(); 
        }

        generateBtn.addEventListener("click", async ()=>{
          const name = document.getElementById("localName").value.trim();
          const insta = document.getElementById("localInstagram").value.trim();
          const logo = document.getElementById("localLogo").value.trim();
          const bg = document.getElementById("localBg").value.trim();
          if(!name){ document.getElementById("localMessage").innerText="Nombre es obligatorio"; return; }

          let html = await fetchIndexHTML();
          html = html.replace(/Santa Rotiser√≠a/g, name);
          html = html.replace(/Santa/g, name);
          if(insta) html = html.replace(/href=".*?instagram.*?"/g, `href="${insta}"`);
          if(logo) html = html.replace(/(<img[^>]*id=["']logo["'][^>]*src=["']).*?"/, `$1${logo}"`);
          if(bg) html = html.replace(/(<img[^>]*id=["']bg["'][^>]*src=["']).*?"/, `$1${bg}"`);
          previewFrame.srcdoc = html;

          const blob = new Blob([html], {type:"text/html"});
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = name.replace(/\s/g,"_")+".html";
          link.click();
        });

      } else {
        document.getElementById("mainContent").innerHTML = `<h2>${section}</h2><p>Contenido de la secci√≥n ${section} aqu√≠.</p>`;
      }
    });
  });

  const toggleBtn = document.getElementById("toggleSidebarBtn");
  toggleBtn.addEventListener("click", () => { sidebar.classList.toggle("collapsed"); });
});
</script>

<style>
body{margin:0;font-family: Arial, sans-serif; background:#ffffff;color:#000; min-height:100vh; display:flex; flex-direction:column; overflow-x: hidden;}
header{width:100%; padding:20px; text-align:center; font-size:24px; font-weight:bold; background:#ffffff; border-bottom:1px solid #ccc; display:flex; flex-direction:column; gap:8px;}
.header-subtitle{font-size:16px; font-weight:normal; color:#555; display:none;}
#loginDiv{flex:1; display:flex; justify-content:center; align-items:flex-start; padding-top:60px;}
.form-container{background:#171a21; padding:20px; border-radius:12px; width:300px; display:flex; flex-direction:column; gap:12px; color:#fff; align-items:center; box-shadow:0 4px 15px rgba(0,0,0,0.3);}
input{padding:10px; border-radius:8px; border:none; font-size:14px; width:100%;}
label{font-size:14px; display:flex; align-items:center; gap:6px;}
button{padding:10px; border:none; border-radius:8px; background:#22c55e; color:#fff; font-weight:bold; cursor:pointer; width:100%;}
#dashboardDiv{display:none; flex-direction:row; height:100vh; overflow-x:hidden;}
#sidebar{position:fixed; top:0; left:0; width:220px; height:100vh; background:#171a21; color:#fff; display:flex; flex-direction:column; justify-content:space-between; box-shadow:2px 0 5px rgba(0,0,0,0.2); padding:0; transition: width 0.3s; overflow:hidden;}
#sidebarTop{display:flex; justify-content:flex-end; padding:10px;}
#toggleSidebarBtn{background:#22c55e; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-weight:bold;}
#sidebarMenu{margin-top:20px;}
#sidebarMenu ul{list-style: none; padding:0; margin:0;}
#sidebarMenu ul li{padding:15px 20px; cursor:pointer; transition:0.2s; border-left:4px solid transparent; display:flex; align-items:center; gap:10px;}
#sidebarMenu ul li:hover{background:#1f222a;}
#sidebarMenu ul li.active{border-left:4px solid #22c55e; background:#1f222a;}
#sidebar.collapsed{width:60px;}
#sidebar.collapsed #sidebarMenu li{justify-content:center; padding:12px 0;}
#sidebar.collapsed #sidebarMenu li span{display:none;}
#sidebar.collapsed #sidebarTop{justify-content:center;}
#sidebar.collapsed #toggleSidebarBtn{padding:6px 8px; margin:0;}
#mainContent{flex:1; margin-left:220px; max-width:calc(1000px + 300px); padding:20px; overflow-x:hidden; transition: margin-left 0.3s; display:flex;}
#sidebar.collapsed + #mainContent{margin-left:60px;}
#logoutBtn{background:#f43f5e; color:#fff; border:none; padding:12px 25px; border-radius:6px; cursor:pointer; font-weight:bold; width:auto; min-width:50px; margin:20px auto; display:flex; align-items:center; justify-content:center; gap:5px;}
#logoutBtn::before{content:"üö™";}
#sidebar.collapsed #logoutBtn span{display:none;}
#sidebar.collapsed #logoutBtn{width:40px; padding:12px 0;}
.menu-text{display:inline;}
#sidebar.collapsed .menu-text{display:none;}
.user-page{display:flex; gap:20px; width:100%;}
.user-form{background:#f4f4f4; padding:20px; border-radius:12px; max-width:400px; flex:1; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.user-form .form-group{display:flex; flex-direction:column; margin-bottom:15px;}
.user-form .form-group label{font-weight:bold; margin-bottom:5px; color:#333;}
.user-form .form-group input{padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px;}
#saveUserBtn,#generateBtn{background:#22c55e; color:#fff; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; width:100%; transition:0.2s;}
#saveUserBtn:hover,#generateBtn:hover{background:#16a34a;}
#userMessage,#localMessage{margin-top:10px; font-weight:bold; color:#16a34a;}
.user-list{background:#f4f4f4; padding:20px; border-radius:12px; width:300px; box-shadow:0 2px 10px rgba(0,0,0,0.1); flex-shrink:0;}
.user-list input{width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
.user-row{display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #ccc;}
.user-actions button{margin-left:5px; padding:3px 6px; border:none; border-radius:4px; cursor:pointer; font-size:12px;}
.user-actions .edit-btn{background:#facc15; color:#fff;}
.user-actions .delete-btn{background:#f43f5e; color:#fff;}
</style>
</head>

<body>
<header>
  <div class="header-title">Gestor de Locales/Usuarios</div>
  <div class="header-subtitle" id="welcomeMessage">Bienvenido al Panel Backdoor. Aqu√≠ podr√°s gestionar usuarios y locales.</div>
</header>

<div id="loginDiv">
  <form id="loginForm" class="form-container">
    <input type="email" id="email" placeholder="Correo electr√≥nico" required>
    <input type="password" id="password" placeholder="Contrase√±a" required>
    <label><input type="checkbox" id="rememberMe"> Recordar sesi√≥n</label>
    <button type="submit">Ingresar</button>
  </form>
</div>

<div id="dashboardDiv">
  <div id="sidebar">
    <div id="sidebarTop">
      <button id="toggleSidebarBtn">‚ò∞</button>
    </div>
    <div id="sidebarMenu">
      <ul>
        <li data-section="Crear Usuarios">üìÑ<span class="menu-text">Creaci√≥n de Usuarios</span></li>
        <li data-section="Generador de Locales">üè¢<span class="menu-text">Generador de Locales</span></li>
      </ul>
    </div>
    <button id="logoutBtn"><span>Cerrar sesi√≥n</span></button>
  </div>
  <div id="mainContent"><!-- Contenido din√°mico --></div>
</div>
</body>
</html>
