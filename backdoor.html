<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backdoor - Gestor de Locales/Usuarios</title>
<style>
/* Estilos base */
body{margin:0;font-family:Arial,sans-serif;background:#fff;color:#000;display:flex;flex-direction:column;min-height:100vh;overflow-x:hidden;}
header{width:100%;padding:20px;text-align:center;font-size:24px;font-weight:bold;background:#fff;border-bottom:1px solid #ccc;display:flex;flex-direction:column;gap:8px;}
.header-subtitle{font-size:16px;font-weight:normal;color:#555;display:none;}
#loginDiv{flex:1;display:flex;justify-content:center;align-items:flex-start;padding-top:60px;}
.form-container{background:#171a21;padding:20px;border-radius:12px;width:320px;display:flex;flex-direction:column;gap:12px;color:#fff;align-items:center;box-shadow:0 4px 15px rgba(0,0,0,0.3);}
input, textarea{padding:10px;border-radius:8px;border:none;font-size:14px;width:100%;}
label{font-size:14px;display:flex;align-items:center;gap:6px;color:#fff;}
button{padding:10px;border:none;border-radius:8px;background:#22c55e;color:#fff;font-weight:bold;cursor:pointer;width:100%;}
#dashboardDiv{display:none;flex-direction:row;height:100vh;overflow-x:hidden;}
#sidebar{position:fixed;top:0;left:0;width:220px;height:100vh;background:#171a21;color:#fff;display:flex;flex-direction:column;justify-content:space-between;box-shadow:2px 0 5px rgba(0,0,0,0.2);padding:0;transition:width 0.3s;overflow:hidden;}
#sidebarTop{display:flex;justify-content:flex-end;padding:10px;}
#toggleSidebarBtn{background:#22c55e;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-weight:bold;}
#sidebarMenu{margin-top:20px;}
#sidebarMenu ul{list-style:none;padding:0;margin:0;}
#sidebarMenu ul li{padding:15px 20px;cursor:pointer;transition:0.2s;border-left:4px solid transparent;display:flex;align-items:center;gap:10px;}
#sidebarMenu ul li:hover{background:#1f222a;}
#sidebarMenu ul li.active{border-left:4px solid #22c55e;background:#1f222a;}
#sidebar.collapsed{width:60px;}
#sidebar.collapsed #sidebarMenu li{justify-content:center;padding:12px 0;}
#sidebar.collapsed #sidebarMenu li span{display:none;}
#sidebar.collapsed #sidebarTop{justify-content:center;}
#sidebar.collapsed #toggleSidebarBtn{padding:6px 8px;margin:0;}
#mainContent{flex:1;margin-left:220px;max-width:calc(1000px + 300px);padding:20px;overflow-x:hidden;transition:margin-left 0.3s;display:flex;}
#sidebar.collapsed + #mainContent{margin-left:60px;}
#logoutBtn{background:#f43f5e;color:#fff;border:none;padding:12px 25px;border-radius:6px;cursor:pointer;font-weight:bold;width:auto;min-width:50px;margin:20px auto;display:flex;align-items:center;justify-content:center;gap:5px;}
#logoutBtn::before{content:"üö™";}
#sidebar.collapsed #logoutBtn span{display:none;}
#sidebar.collapsed #logoutBtn{width:40px;padding:12px 0;}
.menu-text{display:inline;}
#sidebar.collapsed .menu-text{display:none;}
.user-page{display:flex;gap:20px;width:100%;}
.user-form{background:#f4f4f4;padding:20px;border-radius:12px;max-width:480px;flex:1;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.user-form .form-group{display:flex;flex-direction:column;margin-bottom:15px;}
.user-form .form-group label{font-weight:bold;margin-bottom:5px;color:#333;}
.user-form .form-group input{padding:10px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
#saveUserBtn,#saveLocalBtn{background:#22c55e;color:#fff;border:none;padding:12px;border-radius:6px;font-weight:bold;cursor:pointer;width:100%;transition:0.2s;}
#saveUserBtn:hover,#saveLocalBtn:hover{background:#16a34a;}
#userMessage,#localMessage{margin-top:10px;font-weight:bold;}
#userMessage.success,#localMessage.success{color:#16a34a;}
#userMessage.error,#localMessage.error{color:#f43f5e;}
.user-list{background:#f4f4f4;padding:20px;border-radius:12px;width:320px;box-shadow:0 2px 10px rgba(0,0,0,0.1);flex-shrink:0;}
.user-list input{width:100%;padding:8px;margin-bottom:10px;border-radius:6px;border:1px solid #ccc;}
.user-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #ccc;}
.user-actions button{margin-left:5px;padding:3px 6px;border:none;border-radius:4px;cursor:pointer;font-size:12px;}
.user-actions .edit-btn{background:#facc15;color:#fff;}
.user-actions .delete-btn{background:#f43f5e;color:#fff;}
.muted{color:#666;font-size:13px;}

/* ==== Gesti√≥n Visual de Locales ==== */
.locals-wrapper{display:flex;gap:16px;width:100%;}
.locals-list{width:260px;background:#f4f4f4;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);height:fit-content;}
.locals-list h3{margin:0 0 8px 0;}
.locals-list ul{list-style:none;margin:0;padding:0;max-height:420px;overflow:auto}
.locals-list li{padding:8px 10px;border-radius:8px;cursor:pointer;margin-bottom:6px;background:#fff;border:1px solid #ddd;}
.locals-list li.active{border-color:#22c55e;background:#ecfdf5}
.local-editor{flex:1;background:#f4f4f4;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);}
.local-editor .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.local-editor .row.single{grid-template-columns:1fr}
.local-editor label{font-weight:600;color:#333;margin-top:8px}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.chip{background:#fff;border:1px solid #ddd;border-radius:999px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center}
.chip button{background:#f43f5e;color:#fff;border:none;border-radius:999px;padding:0 6px;height:20px;cursor:pointer;width:auto}
.input-file{display:flex;align-items:center;gap:10px}
.preview{width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid #ddd;background:#fff}
.save-row{display:flex;gap:8px;margin-top:12px}
</style>
</head>
<body>
<header>
  <div class="header-title">Gestor de Locales/Usuarios</div>
  <div class="header-subtitle" id="welcomeMessage">
    Bienvenido al Panel Backdoor. Aqu√≠ podr√°s gestionar usuarios y locales.
  </div>
</header>

<div id="loginDiv">
  <form id="loginForm" class="form-container">
    <input type="email" id="email" placeholder="Correo electr√≥nico" required>
    <input type="password" id="password" placeholder="Contrase√±a" required>
    <label style="color:#fff;"><input type="checkbox" id="rememberMe"> Recordar sesi√≥n</label>
    <button type="submit">Ingresar</button>
  </form>
</div>

<div id="dashboardDiv">
  <div id="sidebar">
    <div id="sidebarTop">
      <button id="toggleSidebarBtn">‚ò∞</button>
    </div>
    <div id="sidebarMenu">
      <ul>
        <li data-section="Crear Usuarios">üìÑ<span class="menu-text">Creaci√≥n de Usuarios</span></li>
        <li data-section="Gesti√≥n de Locales">üè¢<span class="menu-text">Gesti√≥n Visual de Locales</span></li>
        <li data-section="Generador de Locales">‚öôÔ∏è<span class="menu-text">Generador de Locales</span></li>
      </ul>
    </div>
    <button id="logoutBtn"><span>Cerrar sesi√≥n</span></button>
  </div>

  <div id="mainContent">
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div class="muted">Seleccion√° una opci√≥n del men√∫ para comenzar.</div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, query, where, serverTimestamp, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAou7COlKKf0mJCnwEefntTKVGI2cxxJrU",
  authDomain: "santa-roti.firebaseapp.com",
  projectId: "santa-roti",
  storageBucket: "santa-roti.appspot.com",
  messagingSenderId: "66221970620",
  appId: "1:66221970620:web:53083ce7727ff85e6d2cb9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

document.addEventListener("DOMContentLoaded", () => {
  const loginDiv = document.getElementById("loginDiv");
  const dashboardDiv = document.getElementById("dashboardDiv");
  const logoutBtn = document.getElementById("logoutBtn");
  const welcomeMessage = document.getElementById("welcomeMessage");
  const sidebar = document.getElementById("sidebar");
  const sidebarMenu = document.getElementById("sidebarMenu");
  const toggleSidebarBtn = document.getElementById("toggleSidebarBtn");
  const mainContent = document.getElementById("mainContent");

  welcomeMessage.style.display = "none";

  function showDashboard(user){
    loginDiv.style.display = "none";
    dashboardDiv.style.display = "flex";
    welcomeMessage.style.display = "block";
    welcomeMessage.textContent = `Bienvenido ${user.email}`;
  }
  function showLogin(){
    dashboardDiv.style.display = "none";
    loginDiv.style.display = "flex";
    welcomeMessage.style.display = "none";
  }

  onAuthStateChanged(auth, (user) => { user ? showDashboard(user) : showLogin(); });

  const loginForm = document.getElementById("loginForm");
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const rememberMe = document.getElementById("rememberMe").checked;
    try {
      await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);
      await signInWithEmailAndPassword(auth,email,password);
      loginForm.reset();
    } catch(err){ alert("Error: "+err.message); }
  });

  logoutBtn.addEventListener("click", async ()=>{ try{ await signOut(auth); } catch(err){ alert("Error al cerrar sesi√≥n: "+err.message); }});
  toggleSidebarBtn.addEventListener("click", ()=>{ sidebar.classList.toggle("collapsed"); });

  sidebarMenu.addEventListener("click", (ev) => {
    const li = ev.target.closest('li[data-section]'); if(!li) return;
    sidebarMenu.querySelectorAll('li').forEach(i=>i.classList.remove('active'));
    li.classList.add('active');
    const section = li.getAttribute('data-section');
    if(section === "Crear Usuarios") renderCrearUsuarios();
    else if(section === "Gesti√≥n de Locales") renderGestionLocales();
    else if(section === "Generador de Locales") renderGeneradorLocales();
  });

  /* ====== CREAR USUARIOS ====== */
  function renderCrearUsuarios(){
    mainContent.innerHTML = `
      <div class="user-page">
        <div id="userFormContainer" class="user-form">
          <h2>Creaci√≥n de Usuarios</h2>
          <div class="form-group">
            <label for="newUsername">Nombre de Usuario:</label>
            <input type="text" id="newUsername" placeholder="Ingrese nombre de usuario" required>
          </div>
          <div class="form-group">
            <label for="newPassword">Contrase√±a (temporal):</label>
            <input type="password" id="newPassword" placeholder="Ingrese contrase√±a" required>
          </div>
          <div class="form-group">
            <label for="newLocal">Nombre de Local:</label>
            <input type="text" id="newLocal" placeholder="Local asignado" required>
          </div>
          <button id="saveUserBtn">Guardar Usuario</button>
          <div id="userMessage" class="muted"></div>
        </div>

        <div id="userListContainer" class="user-list">
          <h2>Usuarios Existentes</h2>
          <input type="text" id="searchUser" placeholder="Buscar usuario...">
          <div id="userGrid"></div>
        </div>
      </div>
    `;

    const saveUserBtn = document.getElementById("saveUserBtn");
    const userMessage = document.getElementById("userMessage");

    const saveUserHandler = async () => {
      const username = document.getElementById("newUsername").value.trim();
      const password = document.getElementById("newPassword").value.trim();
      const localName = document.getElementById("newLocal").value.trim();
      if(!username || !password || !localName){
        userMessage.textContent = "Completa todos los campos.";
        userMessage.className = "error";
        return;
      }
      try {
        await addDoc(collection(db, "Users"), { username, password, local: localName, createdAt: serverTimestamp() });
        userMessage.textContent = "Usuario creado correctamente.";
        userMessage.className = "success";
        document.getElementById("newUsername").value="";
        document.getElementById("newPassword").value="";
        document.getElementById("newLocal").value="";
        loadUsers();
      } catch(err){
        userMessage.textContent = "Error: "+err.message;
        userMessage.className = "error";
      }
    };
    saveUserBtn.addEventListener("click", saveUserHandler);

    async function loadUsers(search=""){
      const userGrid = document.getElementById("userGrid");
      userGrid.innerHTML = "";
      let qRef = collection(db, "Users");
      if(search){
        qRef = query(collection(db, "Users"), where("username", ">=", search), where("username", "<=", search+"\uf8ff"));
      }
      const querySnapshot = await getDocs(qRef);
      querySnapshot.forEach(docSnap => {
        const userData = docSnap.data();
        const date = userData.createdAt ? new Date(userData.createdAt.seconds*1000).toLocaleString() : "-";
        const userDiv = document.createElement("div");
        userDiv.classList.add("user-row");
        userDiv.innerHTML = `
          <span style="min-width:120px">${userData.username}</span>
          <span style="min-width:140px">${date}</span>
          <div class="user-actions">
            <button class="edit-btn">‚úèÔ∏è</button>
            <button class="delete-btn">üóëÔ∏è</button>
          </div>
        `;
        userDiv.querySelector(".delete-btn").addEventListener("click", async ()=>{ 
          if(confirm("¬øEliminar usuario?")){ await deleteDoc(doc(db,"Users",docSnap.id)); loadUsers(); }
        });
        userDiv.querySelector(".edit-btn").addEventListener("click", ()=>{ 
          document.getElementById("newUsername").value = userData.username;
          document.getElementById("newPassword").value = userData.password;
          document.getElementById("newLocal").value = userData.local;
          userMessage.textContent = "Editando usuario, guardar cambios.";
          userMessage.className = "muted";
          saveUserBtn.onclick = async ()=> {
            await updateDoc(doc(db,"Users",docSnap.id), {
              username: document.getElementById("newUsername").value,
              password: document.getElementById("newPassword").value,
              local: document.getElementById("newLocal").value
            });
            userMessage.textContent = "Usuario actualizado correctamente.";
            userMessage.className = "success";
            loadUsers();
            document.getElementById("newUsername").value="";
            document.getElementById("newPassword").value="";
            document.getElementById("newLocal").value="";
            saveUserBtn.onclick = saveUserHandler;
          };
        });
        userGrid.appendChild(userDiv);
      });
    }
    document.getElementById("searchUser").addEventListener("input", (e)=>{ loadUsers(e.target.value); });
    loadUsers();
  }

  /* ====== GESTI√ìN VISUAL DE LOCALES ====== */
  function renderGestionLocales(){
    mainContent.innerHTML = `
      <div class="locals-wrapper">
        <div class="locals-list">
          <h3>Locales</h3>
          <div class="row single">
            <input id="newLocalKey" placeholder="nuevo LOCAL_KEY (ej: santa)" />
            <input id="newLocalName" placeholder="Nombre visible (ej: Santa)" />
          </div>
          <button id="btnCreateLocal" style="margin:8px 0;">‚ûï Crear local</button>
          <ul id="localsUl"></ul>
        </div>

        <div class="local-editor" id="localEditor" style="display:none;">
          <h3 id="editorTitle">Editar local</h3>

          <div class="row">
            <div>
              <label>Nombre visible</label>
              <input id="le_localName" placeholder="Ej: Santa Rotiser√≠a" />
            </div>
            <div>
              <label>Instagram (handle)</label>
              <input id="le_instagram" placeholder="ej: santa.roti" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>WhatsApp (E.164 sin +)</label>
              <input id="le_whats" placeholder="ej: 543537581341" />
            </div>
            <div>
              <label>Horarios</label>
              <input id="le_hours" placeholder="ej: Vie-S√°b-Dom 20:00‚Äì23:30" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Direcci√≥n</label>
              <input id="le_address" placeholder="Belgrano 123" />
            </div>
            <div>
              <label>URL Google Maps</label>
              <input id="le_map" placeholder="https://maps.google.com/..." />
            </div>
          </div>

          <div class="row">
            <div class="input-file">
              <div style="display:flex;flex-direction:column;gap:6px;flex:1">
                <label>Logo</label>
                <input type="file" id="le_logoFile" accept="image/*" />
                <small class="muted" id="le_logoUrlTxt"></small>
              </div>
              <img id="le_logoPreview" class="preview" alt="logo"/>
            </div>

            <div class="input-file">
              <div style="display:flex;flex-direction:column;gap:6px;flex:1">
                <label>Fondo</label>
                <input type="file" id="le_bgFile" accept="image/*" />
                <small class="muted" id="le_bgUrlTxt"></small>
              </div>
              <img id="le_bgPreview" class="preview" alt="fondo"/>
            </div>
          </div>

          <hr style="margin:16px 0">

          <label>Categor√≠as</label>
          <div class="chips" id="le_categoriesChips"></div>
          <div class="row single" style="margin-top:6px;">
            <input id="le_newCat" placeholder="Nueva categor√≠a (ej: empanadas)" />
            <button id="le_addCatBtn" style="width:auto;">Agregar</button>
          </div>

          <div class="save-row">
            <button id="le_saveBtn">üíæ Guardar cambios</button>
            <button id="le_refreshBtn" style="background:#9ca3af;color:#0f1115;">‚Üª Recargar</button>
          </div>
        </div>
      </div>
    `;

    document.getElementById('btnCreateLocal').addEventListener('click', createLocalFromInputs);
    loadLocales(); // lista al costado
  }

  // ---------- Firestore paths ----------
  const localsCol = () => collection(db, 'locals');
  const localDoc  = (key) => doc(db, 'locals', key);

  // ---------- Utilidades ----------
  const toSlug = s => (s||'').toString().trim().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

  async function uploadImage(file, path){
    const ref = storageRef(storage, path);
    await uploadBytes(ref, file);
    return await getDownloadURL(ref);
  }

  function chipHtml(text, idx){
    return `<span class="chip">${text}<button data-idx="${idx}" title="Quitar">√ó</button></span>`;
  }

  // ---------- Carga y selecci√≥n de locales ----------
  async function loadLocales(){
    const ul = document.getElementById('localsUl');
    ul.innerHTML = 'Cargando...';

    const snap = await getDocs(localsCol());
    const items = [];
    snap.forEach(d => items.push({ key:d.id, ...d.data() }));

    if(items.length === 0){
      // fallback: inferir keys desde Users.local
      const usersSnap = await getDocs(collection(db,'Users'));
      const set = new Set();
      usersSnap.forEach(u => { if(u.data()?.local) set.add(toSlug(u.data().local)); });
      for (const k of set) items.push({ key:k, localName:k });
    }

    ul.innerHTML = '';
    items.sort((a,b)=> (a.localName||a.key).localeCompare(b.localName||b.key,'es'));

    items.forEach(loc=>{
      const li = document.createElement('li');
      li.textContent = loc.localName || loc.key;
      li.dataset.key = loc.key;
      li.addEventListener('click', ()=> selectLocal(li.dataset.key));
      ul.appendChild(li);
    });
  }

  async function selectLocal(localKey){
    // marcar activo
    document.querySelectorAll('#localsUl li').forEach(li=>{
      li.classList.toggle('active', li.dataset.key===localKey);
    });

    const editor = document.getElementById('localEditor');
    editor.style.display = 'block';
    document.getElementById('editorTitle').textContent = `Editar local ‚Äî ${localKey}`;

    // Cargar doc
    const ref = localDoc(localKey);
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : {
      localKey,
      localName: localKey,
      instagramHandle: '',
      whatsE164: '',
      addressText: '',
      mapUrl: '',
      hoursText: '',
      logoSrc: '',
      backgroundImage: '',
      categories: ['pizza','hamburguesa','papas','menu especial','extras']
    };

    // Pintar UI
    document.getElementById('le_localName').value = data.localName || '';
    document.getElementById('le_instagram').value = data.instagramHandle || '';
    document.getElementById('le_whats').value = data.whatsE164 || '';
    document.getElementById('le_address').value = data.addressText || '';
    document.getElementById('le_map').value = data.mapUrl || '';
    document.getElementById('le_hours').value = data.hoursText || '';
    document.getElementById('le_logoPreview').src = data.logoSrc || 'https://via.placeholder.com/64?text=Logo';
    document.getElementById('le_bgPreview').src = data.backgroundImage || 'https://via.placeholder.com/64?text=BG';
    document.getElementById('le_logoUrlTxt').textContent = data.logoSrc || '';
    document.getElementById('le_bgUrlTxt').textContent = data.backgroundImage || '';

    renderCategoriesChips(data.categories || []);

    // Bind de botones
    document.getElementById('le_addCatBtn').onclick = ()=> addCategory(localKey);
    document.getElementById('le_saveBtn').onclick = ()=> saveLocal(localKey);
    document.getElementById('le_refreshBtn').onclick = ()=> selectLocal(localKey);

    // Uploads
    document.getElementById('le_logoFile').onchange = async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const url = await uploadImage(file, `locals/${localKey}/logo_${Date.now()}.png`);
      document.getElementById('le_logoPreview').src = url;
      document.getElementById('le_logoUrlTxt').textContent = url;
    };
    document.getElementById('le_bgFile').onchange = async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const url = await uploadImage(file, `locals/${localKey}/bg_${Date.now()}.png`);
      document.getElementById('le_bgPreview').src = url;
      document.getElementById('le_bgUrlTxt').textContent = url;
    };
  }

  function renderCategoriesChips(arr){
    const wrap = document.getElementById('le_categoriesChips');
    wrap.innerHTML = '';
    (arr||[]).forEach((c, idx)=>{
      const div = document.createElement('div');
      div.innerHTML = chipHtml(c, idx);
      // click del bot√≥n √ó
      const btn = div.querySelector('button');
      btn.addEventListener('click', ()=> {
        const input = document.getElementById('le_newCat'); // temporal
        // marcar para quitar en save (re-render lo har√° al guardar o recargar)
        const tmp = Array.from(wrap.querySelectorAll('.chip')).map(ch => ch.firstChild.textContent);
        tmp.splice(idx,1);
        renderCategoriesChips(tmp);
      });
      wrap.appendChild(div.firstChild);
    });
  }

  function currentCategoriesFromUI(){
    return Array.from(document.querySelectorAll('#le_categoriesChips .chip'))
      .map(ch => (ch.firstChild?.textContent || '').toString().trim())
      .filter(Boolean);
  }

  function addCategory(localKey){
    const input = document.getElementById('le_newCat');
    const v = (input.value || '').trim();
    if(!v) return;
    const cats = currentCategoriesFromUI();
    if(!cats.includes(v)) cats.push(v);
    renderCategoriesChips(cats);
    input.value = '';
  }

  async function saveLocal(localKey){
    const payload = {
      localKey,
      localName: document.getElementById('le_localName').value.trim(),
      instagramHandle: document.getElementById('le_instagram').value.trim(),
      whatsE164: document.getElementById('le_whats').value.trim(),
      addressText: document.getElementById('le_address').value.trim(),
      mapUrl: document.getElementById('le_map').value.trim(),
      hoursText: document.getElementById('le_hours').value.trim(),
      logoSrc: document.getElementById('le_logoUrlTxt').textContent.trim(),
      backgroundImage: document.getElementById('le_bgUrlTxt').textContent.trim(),
      categories: currentCategoriesFromUI()
    };
    await setDoc(localDoc(localKey), payload, { merge:true });
    alert('Cambios guardados.');
  }

  async function createLocalFromInputs(){
    const key = toSlug(document.getElementById('newLocalKey').value || '');
    const name = (document.getElementById('newLocalName').value || '').trim();
    if(!key || !name){ alert('Complet√° LOCAL_KEY y Nombre visible'); return; }
    const exists = await getDoc(localDoc(key));
    if(exists.exists()){ alert('Ese LOCAL_KEY ya existe'); return; }
    await setDoc(localDoc(key), {
      localKey:key,
      localName:name,
      instagramHandle:'',
      whatsE164:'',
      addressText:'',
      mapUrl:'',
      hoursText:'',
      logoSrc:'',
      backgroundImage:'',
      categories:['pizza','hamburguesa','papas','menu especial','extras'],
      createdAt: new Date()
    });
    document.getElementById('newLocalKey').value='';
    document.getElementById('newLocalName').value='';
    await loadLocales();
    selectLocal(key);
  }

  /* ====== GENERADOR DE LOCALES: SOLO LOCAL_KEY y LOCAL_NAME ====== */
  function renderGeneradorLocales(){
    mainContent.innerHTML = `
      <div class="user-page">
        <div id="localFormContainer" class="user-form">
          <h2>Generador de Locales desde plantilla Index.html</h2>

          <div class="form-group">
            <label for="localKey">Identificador (LOCAL_KEY):</label>
            <input type="text" id="localKey" placeholder="ej: honey, norte, sur" required>
          </div>

          <div class="form-group">
            <label for="localName">Nombre para mostrar (LOCAL_NAME):</label>
            <input type="text" id="localName" placeholder="ej: Honey Rotiser√≠a" required>
          </div>

          <button id="saveLocalBtn">Generar archivo</button>
          <div id="localMessage" class="muted"></div>
        </div>
      </div>
    `;

    const localMessage = document.getElementById("localMessage");

    const sanitizeSlug = (s) =>
      s.toString().trim().toLowerCase()
       .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
       .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

    const replaceAllMap = (html, mapping) => {
      for (const [key, value] of Object.entries(mapping)) {
        const regex = new RegExp(`{{\\s*${key}\\s*}}`, 'g');
        html = html.replace(regex, value ?? '');
      }
      return html;
    };

    const fetchTemplate = async () => {
      const candidates = ['Index.html','./Index.html','index.html'];
      let lastErr;
      for (const url of candidates) {
        try {
          const res = await fetch(url, { cache: 'no-cache' });
          if(res.ok) return await res.text();
          lastErr = `HTTP ${res.status}`;
        } catch(e){ lastErr = e.message; }
      }
      throw new Error(`No se pudo cargar la plantilla (Intent√©: ${candidates.join(', ')}). ${lastErr||''}`);
    };

    document.getElementById("saveLocalBtn").addEventListener("click", async () => {
      const LOCAL_KEY = sanitizeSlug(document.getElementById("localKey").value || '');
      const LOCAL_NAME = document.getElementById("localName").value || '';

      if(!LOCAL_KEY || !LOCAL_NAME){
        localMessage.textContent = "Debes ingresar LOCAL_KEY y LOCAL_NAME.";
        localMessage.className = "error";
        return;
      }

      try {
        let template = await fetchTemplate();
        template = replaceAllMap(template, { LOCAL_KEY, LOCAL_NAME });

        const blob = new Blob([template], {type:"text/html;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `index-${LOCAL_KEY}.html`;
        a.click();
        URL.revokeObjectURL(a.href);

        localMessage.textContent = `Archivo generado: index-${LOCAL_KEY}.html`;
        localMessage.className = "success";
      } catch(err){
        localMessage.textContent = "Error: " + err.message;
        localMessage.className = "error";
      }
    });
  }

  // Inicial: primera secci√≥n
  const firstLi = sidebarMenu.querySelector('li[data-section]');
  if(firstLi) firstLi.classList.add('active');
  renderCrearUsuarios();
});
</script>
</body>
</html>
