<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Administraci√≥n - Santa‚Äôs</title>

<style>
  :root {
    --verde: #16a34a;
    --gris-claro: #f3f4f6;
    --gris-oscuro: #1f2937;
    --texto: #111827;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    background-color: var(--gris-claro);
    color: var(--texto);
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  header {
    background: var(--verde);
    color: #fff;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 20;
  }

  header h1 {
    font-size: 1.3rem;
    margin: 0;
  }

  #menu-toggle {
    display: none;
    background: none;
    border: none;
    color: #fff;
    font-size: 1.8rem;
    cursor: pointer;
  }

  #sidebar {
    position: fixed;
    top: 60px;
    left: 0;
    width: 220px;
    height: calc(100vh - 60px);
    background-color: var(--gris-oscuro);
    color: #fff;
    padding: 15px;
    overflow-y: auto;
    transition: left 0.3s ease;
    z-index: 10;
  }

  #sidebar.hidden {
    left: -220px;
  }

  #sidebar h2 {
    font-size: 1rem;
    margin-top: 0;
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }

  main {
    margin-left: 220px;
    padding: 80px 20px 20px;
    min-height: 100vh;
    transition: margin-left 0.3s ease;
  }

  /* LOGIN */
  #login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: var(--gris-claro);
  }

  #login-box {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 350px;
    text-align: center;
    animation: fadeIn 0.5s ease;
  }

  #login-box h2 {
    margin-bottom: 20px;
    color: var(--verde);
  }

  input[type="text"], input[type="password"] {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  button {
    background-color: var(--verde);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  button:hover {
    background-color: #15803d;
  }

  /* LISTA DE PRODUCTOS */
  #productos-lista {
    list-style: none;
    padding: 0;
  }

  #productos-lista li {
    background: white;
    margin: 10px 0;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s ease;
  }

  #productos-lista li:hover {
    transform: translateY(-2px);
  }

  #productos-lista button {
    margin: 5px 5px 0 0;
    flex-shrink: 0;
  }

  #productos-lista .acciones {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    #menu-toggle {
      display: block;
    }

    #sidebar {
      left: -220px;
      top: 60px;
      height: calc(100vh - 60px);
      box-shadow: 4px 0 12px rgba(0,0,0,0.2);
      background: #1e293b;
    }

    #sidebar.open {
      left: 0;
    }

    #sidebar.open::after {
      content: "";
      position: fixed;
      top: 0;
      left: 220px;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.3);
      z-index: -1;
    }

    main {
      margin-left: 0;
      padding: 80px 10px;
    }

    #productos-lista li {
      flex-direction: column;
      align-items: flex-start;
    }

    #productos-lista .acciones {
      width: 100%;
      justify-content: flex-start;
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login-container">
  <div id="login-box">
    <h2>Acceso Administrativo</h2>
    <input type="text" id="usuario" placeholder="Usuario">
    <input type="password" id="password" placeholder="Contrase√±a">
    <button id="login-btn">Ingresar</button>
  </div>
</div>

<!-- PANEL -->
<header id="panel-header" style="display:none;">
  <button id="menu-toggle">‚ò∞</button>
  <h1>Panel de Administraci√≥n</h1>
  <button id="logout-btn">Cerrar sesi√≥n</button>
</header>

<aside id="sidebar" class="hidden">
  <h2>Men√∫</h2>
  <!-- (Aqu√≠ manten√©s tu contenido original del sidebar) -->
</aside>

<main id="panel-main" style="display:none;">
  <section id="productos">
    <h2>Productos</h2>
    <ul id="productos-lista">
      <li>
        <span>Hamburguesa Cl√°sica</span>
        <div class="acciones">
          <button>Editar</button>
          <button>Borrar</button>
        </div>
      </li>
      <li>
        <span>Santa Deluxe</span>
        <div class="acciones">
          <button>Editar</button>
          <button>Borrar</button>
        </div>
      </li>
    </ul>
  </section>
</main>

<script>
  const loginBtn = document.getElementById('login-btn');
  const loginContainer = document.getElementById('login-container');
  const panelHeader = document.getElementById('panel-header');
  const panelMain = document.getElementById('panel-main');
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menu-toggle');
  const logoutBtn = document.getElementById('logout-btn');

  loginBtn.addEventListener('click', () => {
    loginContainer.style.display = 'none';
    panelHeader.style.display = 'flex';
    panelMain.style.display = 'block';
    panelMain.style.animation = 'fadeIn 0.5s ease';
  });

  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('open');
    sidebar.classList.toggle('hidden');
  });

  logoutBtn.addEventListener('click', () => {
    panelHeader.style.display = 'none';
    panelMain.style.display = 'none';
    loginContainer.style.display = 'flex';
  });
</script>

<script type="module">
/* ================== MANTENGO TUS IMPORTS ORIGINALES ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
  getFirestore, collection, doc, getDocs, getDoc, query, where, 
  onSnapshot, deleteDoc, addDoc, setDoc 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { 
  getStorage, ref as storageRef, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAou7COlKKf0mJCnwEefntTKVGI2cxxJrU",
  authDomain: "santa-roti.firebaseapp.com",
  projectId: "santa-roti",
  storageBucket: "santa-roti.firebasestorage.app",
  messagingSenderId: "66221970620",
  appId: "1:66221970620:web:53083ce7727ff85e6d2cb9",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------- Estado ---------- */
let currentUserLocal = null;
let currentCategories = [];
let unsubscribeProducts = null;
const DEFAULT_CATS = ['pizza','hamburguesa','papas','menu especial','extras'];
const slug = s => (s||'').toString().trim().toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

/* ================== Persistencia UI (theme & sidebar) ================== */
const THEME_KEY = 'adminThemePref';
const SIDEBAR_KEY = 'adminSidebarPref';

function readTheme(){ return localStorage.getItem(THEME_KEY) || 'light'; }
function writeTheme(v){ localStorage.setItem(THEME_KEY, v); }

function readSidebar(){ return localStorage.getItem(SIDEBAR_KEY) === 'collapsed'; }
function writeSidebar(collapsed){ localStorage.setItem(SIDEBAR_KEY, collapsed ? 'collapsed' : 'expanded'); }

/* ================== DOM ELEMENTS ================== */
const loginDiv = document.getElementById('loginDiv');
const dashboardDiv = document.getElementById('dashboardDiv');
const welcomeMessage = document.getElementById('welcomeMessage');
const sidebar = document.getElementById('sidebar');
const sidebarMenu = document.getElementById('sidebarMenu');
const mainContent = document.getElementById('mainContent');
const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
const logoutBtn = document.getElementById('logoutBtn');
const themeToggleBtn = document.getElementById('themeToggleBtn');
const themeIcon = document.getElementById('themeIcon');
const mobileSearchBtn = document.getElementById('mobileSearchBtn');
const searchInline = document.getElementById('searchInline');

/* ========== Theme init ========== */
function applyTheme(theme){
  if(theme === 'light'){
    document.body.classList.add('light');
    document.body.classList.remove('dark');
    themeIcon.textContent = '‚òÄÔ∏è';
  } else {
    document.body.classList.remove('light');
    document.body.classList.add('dark');
    themeIcon.textContent = 'üåô';
  }
  writeTheme(theme);
}
applyTheme(readTheme());

themeToggleBtn.addEventListener('click', ()=>{
  const next = document.body.classList.contains('light') ? 'dark' : 'light';
  applyTheme(next);
});

/* ========== Sidebar init & behavior ========== */
function applySidebarState(collapsed){
  if(collapsed){
    sidebar.classList.add('collapsed');
    sidebar.setAttribute('aria-hidden','true');
  }else{
    sidebar.classList.remove('collapsed');
    sidebar.setAttribute('aria-hidden','false');
  }
  writeSidebar(collapsed);
}
// apply stored sidebar preference
applySidebarState(readSidebar());

toggleSidebarBtn.addEventListener('click', ()=>{
  // on small screens toggle overlay open
  if(window.matchMedia("(max-width:900px)").matches){
    sidebar.classList.toggle('open');
  } else {
    sidebar.classList.toggle('collapsed');
    writeSidebar(sidebar.classList.contains('collapsed'));
  }
});

// close mobile sidebar by clicking outside
document.addEventListener('click', (e)=>{
  if(window.matchMedia("(max-width:900px)").matches){
    if(!sidebar.classList.contains('open')) return;
    if(!sidebar.contains(e.target) && !toggleSidebarBtn.contains(e.target)){
      sidebar.classList.remove('open');
    }
  }
});

/* ========== ORIGINAL AUTH (Users) CODE (sin tocar la l√≥gica) ========== */
document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  if(!username || !password) return alert("Complet√° usuario y contrase√±a");

  try{
    const q = query(collection(db, "Users"), where("username", "==", username));
    const qs = await getDocs(q);
    if(qs.empty) return alert("Usuario no encontrado");
    const user = qs.docs[0].data();
    if(user.password !== password) return alert("Contrase√±a incorrecta");

    const sess = JSON.stringify({username, local: user.local});
    (document.getElementById('rememberMe').checked ? localStorage : sessionStorage).setItem("session", sess);
    await showDashboard(user.username || username, user.local);
  }catch(err){
    console.error(err); alert("Error al iniciar sesi√≥n: "+err.message);
  }
});

document.addEventListener("DOMContentLoaded", async ()=>{
  const session = localStorage.getItem("session") || sessionStorage.getItem("session");
  if(session){
    const data = JSON.parse(session);
    await showDashboard(data.username, data.local);
  }
});

logoutBtn.addEventListener('click', ()=>{
  localStorage.removeItem("session");
  sessionStorage.removeItem("session");
  hideDashboard();
});

/* ========== Layout: sidebar menu navigation ========== */
sidebarMenu.addEventListener('click', (e)=>{
  const li = e.target.closest('li[data-section]'); if(!li) return;
  sidebarMenu.querySelectorAll('li').forEach(el=>el.classList.remove('active'));
  li.classList.add('active');
  const section = li.getAttribute('data-section');
  if(section==='productos') renderProductosPage();
  if(section==='descuentos') renderDescuentosPage();
});

/* ========== Dashboard show/hide (con fade) ========== */
async function showDashboard(username, local){
  // hide login with fade out
  loginDiv.style.opacity = '0';
  loginDiv.style.transform = 'translateY(8px)';
  loginDiv.style.pointerEvents = 'none';
  // small delay to allow visual fade
  setTimeout(()=>{
    loginDiv.style.display='none';
    // reveal dashboard with smooth fade-in
    dashboardDiv.classList.add('visible');
    dashboardDiv.setAttribute('aria-hidden','false');
  }, 180);

  welcomeMessage.textContent = `Bienvenido ${username}. Local: ${local}`;
  currentUserLocal = local;

  await initCategoriesFromLocal();
  // default: productos view
  renderProductosPage();

  // ensure main content is focused for accessibility
  setTimeout(()=>{ mainContent.focus(); }, 350);
}
function hideDashboard(){
  // hide dashboard with fade out
  dashboardDiv.classList.remove('visible');
  dashboardDiv.setAttribute('aria-hidden','true');
  // small delay then show login
  setTimeout(()=>{
    dashboardDiv.style.display = 'block'; // ensure not removed
    loginDiv.style.display='flex';
    loginDiv.style.opacity='1';
    loginDiv.style.transform='translateY(0)';
    loginDiv.style.pointerEvents='auto';
  }, 220);
  currentUserLocal = null;
  currentCategories = [];
  if(unsubscribeProducts){unsubscribeProducts(); unsubscribeProducts=null;}
}

/* ========== Categor√≠as din√°micas (sin tocar mayormente) ========== */
async function initCategoriesFromLocal(){
  const key = slug(currentUserLocal);
  const ref = doc(db, 'locals', key);
  const snap = await getDoc(ref);
  if(snap.exists()){
    const cats = Array.isArray(snap.data().categories) ? snap.data().categories : [];
    currentCategories = cats.length ? cats : DEFAULT_CATS;
  }else{
    currentCategories = DEFAULT_CATS;
  }
  onSnapshot(ref, d=>{
    if(!d.exists()) return;
    const cats = Array.isArray(d.data().categories) ? d.data().categories : [];
    const next = cats.length ? cats : DEFAULT_CATS;
    if(JSON.stringify(next)!==JSON.stringify(currentCategories)){
      currentCategories = next;
      const active = sidebarMenu.querySelector('li.active')?.getAttribute('data-section');
      if(active==='productos') renderProductosPage();
      if(active==='descuentos') renderDescuentosPage();
    }
  });
}

/* ========================== VISTA: PRODUCTOS ========================== */
function renderProductosPage(){
  if(unsubscribeProducts){unsubscribeProducts(); unsubscribeProducts=null;}

  mainContent.innerHTML = `
    <div class="section card">
      <h2 style="margin:0 0 8px 0">Agregar / Editar Producto</h2>
      <form id="productForm">
        <input type="hidden" id="editId" />
        <label class="field" for="name">Nombre</label>
        <input id="name" placeholder="Ej: Pizza Muzza" required />

        <label class="field" for="desc">Descripci√≥n</label>
        <input id="desc" placeholder="Salsa, muzza, aceitunas" required />

        <label class="field" for="price">Precio</label>
        <input id="price" type="number" placeholder="5000" required />

        <label class="field" for="position">Orden (1..n)</label>
        <input id="position" type="number" min="1" placeholder="1" />

        <label class="field" for="productDiscount">Descuento del producto (%)</label>
        <input id="productDiscount" type="number" min="0" max="100" step="1" placeholder="0" />

        <label class="field" for="img">Imagen</label>
        <input id="img" type="file" accept="image/*" />
        <img id="imgPreview" src="https://via.placeholder.com/150x100?text=Sin+imagen" alt="Vista previa"/>

        <label class="field" for="category">Categor√≠a</label>
        <select id="category" required></select>

        <!-- ‚úÖ NUEVO: estado activo/inactivo -->
        <label class="field" for="isActive">Estado</label>
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="isActive" checked /> Producto activo
        </label>

        <div class="actions-row">
          <button class="primary" id="submitBtn" type="submit">Guardar producto</button>
          <button class="secondary" id="cancelEditBtn" type="button" style="display:none">Cancelar edici√≥n</button>
        </div>
      </form>
    </div>

    <div class="section card">
      <div class="actions-row" style="justify-content:space-between;align-items:center;width:100%">
        <h2 style="margin:0">Productos existentes</h2>
        <div class="search-wrapper"><input id="search" placeholder="Buscar por nombre..." autocomplete="off"/></div>
      </div>
      <div id="productLists"></div>
    </div>
  `;

  const productForm = document.getElementById('productForm');
  const editIdInput = document.getElementById('editId');
  const nameInput = document.getElementById('name');
  const descInput = document.getElementById('desc');
  const priceInput = document.getElementById('price');
  const posInput = document.getElementById('position');
  const prodDiscInput = document.getElementById('productDiscount');
  const imgInput = document.getElementById('img');
  const imgPreview = document.getElementById('imgPreview');
  const catSelect = document.getElementById('category');
  const searchInput = document.getElementById('search');
  const productLists = document.getElementById('productLists');
  const isActiveInput = document.getElementById('isActive');

  // Select categor√≠as
  catSelect.innerHTML = `<option value="">Seleccionar categor√≠a</option>`;
  currentCategories.forEach(cat=>{
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = capitalize(cat);
    catSelect.appendChild(opt);
  });

  // Listas por categor√≠a
  productLists.innerHTML = '';
 currentCategories.forEach(cat=>{
  const sec = document.createElement('div');
  sec.className='category-section';
  sec.dataset.cat = cat;

  // encabezado con checkbox de activar/inactivar categor√≠a
  const header = document.createElement('div');
  header.style.display = 'flex';
  header.style.alignItems = 'center';
  header.style.gap = '10px';
  header.style.marginBottom = '6px';

  const title = document.createElement('h3');
  title.textContent = capitalize(cat);
  title.style.margin = '0';

  const toggleAll = document.createElement('input');
  toggleAll.type = 'checkbox';
  toggleAll.checked = getCatToggle(cat);
  toggleAll.title = 'Activar/Inactivar todos los productos de esta categor√≠a';

  toggleAll.addEventListener('change', async ()=>{
    const activar = toggleAll.checked;
    const confirmMsg = activar
      ? `¬øActivar todos los productos de "${capitalize(cat)}"?`
      : `¬øInactivar todos los productos de "${capitalize(cat)}"?`;
    if(!confirm(confirmMsg)){ toggleAll.checked = !activar; return; }

    try {
      const q = query(collection(db, 'productos'), where('local', '==', currentUserLocal), where('category', '==', cat));
      const qs = await getDocs(q);
      const updates = qs.docs.map(d => 
        setDoc(doc(db, 'productos', d.id), { active: activar, updatedAt: new Date() }, { merge: true })
      );
      await Promise.all(updates);
      setCatToggle(cat, activar);
      alert(`Productos de "${capitalize(cat)}" ${activar ? 'activados' : 'inactivados'}.`);
    } catch(err){
      console.error(err);
      alert('Error al actualizar productos: ' + err.message);
      toggleAll.checked = !activar;
    }
  });

  header.appendChild(title);
  header.appendChild(toggleAll);
  sec.appendChild(header);

  const list = document.createElement('ul');
  list.className = 'items';
  list.id = `list-${slug(cat)}`;
  sec.appendChild(list);

  productLists.appendChild(sec);
});

  // Helpers form
  function setEditMode(on){
    document.getElementById('submitBtn').textContent = on ? 'Actualizar producto' : 'Guardar producto';
    document.getElementById('cancelEditBtn').style.display = on ? 'inline-flex' : 'none';
  }
  function resetForm(){
    productForm.reset();
    editIdInput.value='';
    imgPreview.src="https://via.placeholder.com/150x100?text=Sin+imagen";
    isActiveInput.checked = true;
    setEditMode(false);
  }
  imgInput.addEventListener('change', e=>{
    const f=e.target.files?.[0];
    if(!f){imgPreview.src="https://via.placeholder.com/150x100?text=Sin+imagen";return;}
    const r=new FileReader(); r.onload=ev=>imgPreview.src=ev.target.result; r.readAsDataURL(f);
  });
  document.getElementById('cancelEditBtn').addEventListener('click', resetForm);

  productForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = nameInput.value.trim();
    const desc = descInput.value.trim();
    const price = parseFloat(priceInput.value);
    const position = parseInt(posInput.value,10);
    const discountPct = parseInt(prodDiscInput.value,10);
    const category = catSelect.value;
    const active = !!isActiveInput.checked;
    if(!name||!desc||!price||!category) return alert('Complet√° los campos obligatorios');

    try{
      let imgUrl = '';
      const editId = editIdInput.value;
      if(imgInput.files?.[0]){
        const file=imgInput.files[0];
        const safe=file.name.replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
        const ref=storageRef(storage,`productos/${slug(currentUserLocal)}/${Date.now()}_${safe}`);
        await uploadBytes(ref,file);
        imgUrl = await getDownloadURL(ref);
      }else if(editId){
        const snap = await getDoc(doc(db,'productos',editId));
        if(snap.exists()) imgUrl = snap.data().img || '';
      }

      const productData = {
        name, desc, price, category,
        local: currentUserLocal,
        img: imgUrl,
        position: isNaN(position)?null:position,
        discountPct: isNaN(discountPct)?0:Math.max(0,Math.min(100,discountPct)),
        active,
        updatedAt: new Date()
      };

      if(editId){
        await setDoc(doc(db,'productos',editId), productData);
        alert('Producto actualizado');
      }else{
        await addDoc(collection(db,'productos'), { ...productData, createdAt: new Date() });
        alert('Producto agregado');
      }
      resetForm();
    }catch(err){
      console.error(err); alert('Error al guardar: '+err.message);
    }
  });

  // Snapshot productos
  const listsMap = {}; currentCategories.forEach(c=> listsMap[c]=document.getElementById(`list-${slug(c)}`));
  if(unsubscribeProducts){unsubscribeProducts();}
  unsubscribeProducts = onSnapshot(collection(db,'productos'), snap=>{
    Object.values(listsMap).forEach(ul=>{ if(ul) ul.innerHTML=''; });
    snap.forEach(d=>{
      const p=d.data();
      if(p.local !== currentUserLocal && slug(p.local)!==slug(currentUserLocal)) return;
      const cat = p.category?.toString();
      const ul = listsMap[cat]; if(!ul) return;

      const li = document.createElement('li');
      li.dataset.name = (p.name||'').toLowerCase();
      if(p.active===false){ li.classList.add('inactive'); }

      const img = document.createElement('img');
      img.src = p.img || 'https://via.placeholder.com/150x100?text=Sin+imagen';
      li.appendChild(img);

      const span = document.createElement('span');
      span.style.flex='1';
      span.innerHTML = `${p.name} ‚Äî ${p.desc} ‚Äî $${p.price}${(p.discountPct||0)>0?` ‚Äî Desc ${p.discountPct}%`:''} ${p.active===false?'<span class="badge-inactive">Inactivo</span>':''}`;
      li.appendChild(span);

      const toggleWrap = document.createElement('div');
      toggleWrap.className = 'toggle-wrap';
      const label = document.createElement('label');
      label.style.fontSize='12px';
      label.style.display='flex';
      label.style.alignItems='center';
      label.style.gap='6px';
      const chk = document.createElement('input');
      chk.type='checkbox';
      chk.checked = (p.active !== false);
      chk.addEventListener('change', async ()=>{
        try{
          await setDoc(doc(db,'productos',d.id), { active: chk.checked, updatedAt: new Date() }, { merge:true });
        }catch(err){
          alert('No se pudo actualizar: '+err.message);
          chk.checked = !chk.checked;
        }
      });
      label.appendChild(chk);
      label.appendChild(document.createTextNode('Activo'));
      toggleWrap.appendChild(label);
      li.appendChild(toggleWrap);

      const btnE = document.createElement('button');
      btnE.className='btn-edit'; btnE.textContent='Editar';
      btnE.onclick=()=>{
        nameInput.value = p.name||'';
        descInput.value = p.desc||'';
        priceInput.value = p.price||'';
        posInput.value = p.position??'';
        prodDiscInput.value = p.discountPct??0;
        catSelect.value = p.category||'';
        editIdInput.value = d.id;
        imgPreview.src = p.img || 'https://via.placeholder.com/150x100?text=Sin+imagen';
        isActiveInput.checked = (p.active !== false);
        setEditMode(true);
        productForm.scrollIntoView({behavior:'smooth'});
      };
      li.appendChild(btnE);

      const btnD = document.createElement('button');
      btnD.className='btn-delete'; btnD.textContent='Borrar';
      btnD.onclick=async()=>{ if(confirm(`¬øEliminar ${p.name}?`)) await deleteDoc(doc(db,'productos',d.id)); };
      li.appendChild(btnD);

      ul.appendChild(li);
    });

    applySearchFilter();
  });

  // B√∫squeda
  function applySearchFilter(){
    const q=(searchInput.value||'').toLowerCase().trim();
    document.querySelectorAll('#productLists .category-section').forEach(sec=>{
      const items = sec.querySelectorAll('li'); let visible=0;
      items.forEach(li=>{
        const show=!q || (li.dataset.name||'').includes(q);
        li.style.display = show ? '' : 'none'; if(show) visible++;
      });
      sec.style.display = q ? (visible ? '' : 'none') : '';
    });
  }
  searchInput.addEventListener('input', applySearchFilter);

  function capitalize(s){return (s||'').charAt(0).toUpperCase()+(s||'').slice(1);}
}

/* ========================== VISTA: DESCUENTOS ========================== */
function renderDescuentosPage(){
  mainContent.innerHTML = `
    <div class="section card">
      <h2 style="margin:0 0 10px 0">Descuentos por categor√≠a</h2>
      <div id="discountsGrid" class="discount-grid"></div>
      <div class="discount-actions">
        <button class="primary" id="saveDiscountsBtn">Guardar descuentos</button>
        <button class="secondary" id="clearDiscountsBtn">Limpiar descuentos</button>
      </div>
      <p class="muted" style="margin-top:8px;color:var(--muted)">
        Se guardan en <code>settings/discounts_{LOCAL_KEY}</code> donde <code>LOCAL_KEY</code> = <em>slug</em> de tu local.
      </p>
    </div>
  `;

  const grid = document.getElementById('discountsGrid');
  grid.innerHTML='';
  currentCategories.forEach(cat=>{
    const row=document.createElement('div');
    row.className='discount-item';
    row.innerHTML=`
      <label>${capitalize(cat)}</label>
      <input type="number" min="0" max="100" step="1" data-cat="${cat}"
        placeholder="%" style="width:90px;text-align:right;background:var(--input-bg);color:var(--text);border:1px solid var(--surface-border);border-radius:6px;padding:6px"/>
    `;
    grid.appendChild(row);
  });

  const key = slug(currentUserLocal);
  const ref = doc(db,'settings',`discounts_${key}`);

  onSnapshot(ref, snap=>{
    const data = snap.exists()? snap.data() : {};
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      const val = clamp(Number(data?.[cat]??0));
      if(document.activeElement!==el) el.value = val;
    });
  });

  document.getElementById('saveDiscountsBtn').onclick = async ()=>{
    const payload = { local: currentUserLocal };
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      payload[cat] = clamp(parseInt(el?.value??'0',10));
    });
    await setDoc(ref,payload,{merge:true});
    alert('Descuentos guardados');
  };
  document.getElementById('clearDiscountsBtn').onclick = async ()=>{
    const payload = { local: currentUserLocal };
    currentCategories.forEach(cat=> payload[cat]=0);
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      if(el) el.value=0;
    });
    await setDoc(ref,payload,{merge:true});
    alert('Descuentos limpiados (0%)');
  };

  function clamp(n){ n=isNaN(n)?0:n; return n<0?0:n>100?100:n; }
  function capitalize(s){return (s||'').charAt(0).toUpperCase()+(s||'').slice(1);}
}

/* ========================== Utilities: toggles por categor√≠a (localStorage) ========================== */
function _togglesKey() {
  return `catToggles:${slug(currentUserLocal || '')}`;
}
function _readToggles() {
  try { return JSON.parse(localStorage.getItem(_togglesKey())) || {}; }
  catch { return {}; }
}
function _writeToggles(map) {
  localStorage.setItem(_togglesKey(), JSON.stringify(map || {}));
}
function getCatToggle(cat) {
  const map = _readToggles();
  return (cat in map) ? !!map[cat] : true;
}
function setCatToggle(cat, value) {
  const map = _readToggles();
  map[cat] = !!value;
  _writeToggles(map);
}

/* ========== Small UI helpers: search sync (header <-> page) ========== */
document.addEventListener('input', (e)=>{
  if(e.target === searchInline){
    const el = document.querySelector('#search');
    if(el) el.value = searchInline.value;
    const ev = new Event('input', { bubbles:true });
    if(el) el.dispatchEvent(ev);
  }
});

/* mobile search button toggles search focus */
mobileSearchBtn.addEventListener('click', ()=>{
  const el = document.querySelector('#search') || searchInline;
  if(el){ el.focus(); }
});

/* ensure mobileSearchBtn only shows on small screens */
function updateMobileControls(){
  if(window.matchMedia("(max-width:900px)").matches){
    mobileSearchBtn.style.display='inline-flex';
    document.querySelector('.search-inline').style.display='block';
  } else {
    mobileSearchBtn.style.display='none';
    document.querySelector('.search-inline').style.display='none';
  }
}
window.addEventListener('resize', updateMobileControls);
updateMobileControls();

</script>
</body>
</html>
