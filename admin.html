<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin ‚Äî Productos del Local</title>

<!-- Fuente moderna -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
/* ========== VARIABLES ========== */
:root{
  --accent: #22c55e; /* verde original */
  --accent-600: #16a34a;
  --bg-900: #0f1115;
  --bg-800: #11151c;
  --card-bg: #171a21;
  --muted: #9aa3b2;
  --text: #f5f7fb;
  --surface-border: #2a2f3a;
  --input-bg: #0f172a;
  --search-bg: #1e293b;
  --shadow: rgba(2,6,23,0.6);
}

/* Light mode overrides (applied to body.light) */
body.light{
  --bg-900: #f6f7fb;
  --bg-800: #eef2ff;
  --card-bg: #ffffff;
  --muted: #475569;
  --text: #0f172a;
  --surface-border: #e6eef6;
  --input-bg: #ffffff;
  --search-bg: #ffffff;
  --shadow: rgba(12,18,30,0.06);
}

/* ========== BASE LAYOUT ========== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:'Poppins', Arial, sans-serif;
  background: linear-gradient(180deg,var(--bg-900) 0%, var(--bg-800) 100%);
  color:var(--text);
  min-height:100vh;
  display:flex;
  flex-direction:column;
  transition: background .25s ease, color .25s ease;
}

/* Header */
.header-container header{
  width:100%;
  padding:12px 16px;
  background:transparent;
  border-bottom:1px solid rgba(255,255,255,0.02);
  display:flex;
  align-items:center;
  gap:10px;
  position:sticky;
  top:0;
  z-index:40;
  backdrop-filter: blur(6px);
}
.header-left{display:flex;flex-direction:column;flex:1;min-width:0}
.header-title{font-size:18px;font-weight:700;letter-spacing:0.2px;overflow:hidden;text-overflow:ellipsis}
#welcomeMessage{font-size:13px;color:var(--muted);margin-top:3px;line-height:1.35}

/* Header controls */
.header-controls{display:flex;align-items:center;gap:8px}
.icon-btn{
  background:var(--card-bg);
  border:1px solid var(--surface-border);
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
  transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
  box-shadow: 0 4px 12px var(--shadow);
}
.icon-btn:hover{ transform:translateY(-2px) }
#themeToggleBtn{font-weight:600}

/* ========== AUTH CARD ========== */
#loginDiv{flex:1;display:flex;align-items:flex-start;justify-content:center;padding-top:60px}
.form-container{
  background:var(--card-bg);
  padding:20px;
  border-radius:12px;
  width:360px;
  display:flex;
  flex-direction:column;
  gap:12px;
  box-shadow:0 6px 26px rgba(2,6,23,0.6);
  transform:translateY(0);
  transition:transform .18s ease, box-shadow .18s ease, opacity .25s ease;
  border:1px solid var(--surface-border);
}
.form-container:hover{
  transform:translateY(-4px);
  box-shadow:0 10px 40px rgba(2,6,23,0.65);
}
.form-container input[type="text"], .form-container input[type="password"]{
  padding:12px;border-radius:8px;border:1px solid var(--surface-border);background:var(--input-bg);color:var(--text);
  font-size:14px;
}
.form-container label{font-size:13px;color:var(--muted)}
.form-container button{padding:11px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;
  box-shadow:0 6px 18px rgba(34,197,94,0.12);
  transition:transform .12s ease, filter .12s ease;
}
.form-container button:hover{transform:translateY(-2px);filter:brightness(.98)}

/* ========== APP LAYOUT ========== */
#dashboardDiv{display:none;flex:1;min-height:0;opacity:0;transition:opacity .35s ease}
#dashboardDiv.visible{display:block;opacity:1} /* fade in class */
.app{display:flex;height:calc(100vh - 66px);position:relative}

/* Sidebar */
#sidebar{
  width:220px;
  background:var(--card-bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
  justify-content:flex-start; /* dejamos que el bot√≥n sea sticky abajo en m√≥vil */
  box-shadow:2px 0 12px rgba(2,6,23,0.6);
  border-right:1px solid var(--surface-border);
  transition:width .22s ease,left .22s ease,background .25s ease, transform .25s ease;
  z-index:90; /* ‚¨Ü SOBRE el header */
  overflow:auto;
}
#sidebarTop{display:flex;justify-content:flex-end;padding:10px}
#toggleSidebarBtn{
  background:var(--accent);
  color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700;font-size:16px;
  transition:all .18s ease;box-shadow:0 6px 18px rgba(34,197,94,0.12)
}
#toggleSidebarBtn:hover{ background:var(--accent-600); transform:scale(1.04) }

#sidebarMenu{margin-top:8px;position:relative;padding:8px}
#sidebarMenu ul{list-style:none;margin:0;padding:0}
#sidebarMenu li{
  padding:12px 14px;cursor:pointer;border-left:4px solid transparent;display:flex;align-items:center;gap:10px;border-radius:8px;margin:6px 4px;
  transition:background .15s ease,color .15s ease, transform .12s ease;
  position:relative;
}
#sidebarMenu li:hover{ background: rgba(34,197,94,0.04); transform:translateX(4px) }
#sidebarMenu li.active{ border-left-color:var(--accent); background: rgba(34,197,94,0.06)}

/* menu text hide when collapsed */
#sidebar.collapsed{width:64px}
#sidebar.collapsed .menu-text{display:none}
#sidebar.collapsed #sidebarTop{justify-content:center}

/* tooltip when collapsed */
#sidebar.collapsed #sidebarMenu li:hover::after{
  content: attr(data-section);
  position:fixed;
  left:78px;
  background:var(--card-bg);
  color:var(--text);
  padding:6px 10px;
  border-radius:6px;
  border:1px solid var(--surface-border);
  box-shadow:0 6px 20px var(--shadow);
  white-space:nowrap;
  z-index:60;
  font-size:13px;
}
  
/* Logout ‚Äî desktop (sidebar) */
#logoutBtn{
  display:flex;
  margin-top:auto;          /* lo empuja al fondo del sidebar */
  padding:12px 14px;
  background:transparent;
  color:#f43f5e;
  font-weight:600;
  border:none;
  border-radius:8px;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  cursor:pointer;
}

#logoutBtn:hover{
  background:rgba(244,63,94,0.12);
}

/* Main content */
#mainContent{flex:1;padding:22px;overflow:auto;}

/* Cards / forms / lists */
.card{background:var(--card-bg);border:1px solid var(--surface-border);border-radius:12px;padding:16px;box-shadow:0 6px 22px var(--shadow)}
.section{margin-bottom:18px}
label.field{font-size:12px;color:var(--muted);margin-top:6px;display:block;line-height:1.6}
input,select,button{border:none}
input,select{padding:10px;border-radius:8px;background:var(--input-bg);color:var(--text);width:100%;border:1px solid var(--surface-border);font-size:14px}
button.primary{background:var(--accent);color:#fff;border-radius:8px;padding:10px;font-weight:700;cursor:pointer;border:1px solid rgba(34,197,94,0.12)}
button.secondary{background:var(--muted);color:var(--bg-900);border-radius:8px;padding:10px;font-weight:700;cursor:pointer}
.actions-row{display:flex;gap:8px;margin-top:8px}
#imgPreview{margin-top:10px;border-radius:8px;width:150px;height:100px;object-fit:cover;border:1px solid var(--surface-border)}

/* items list */
ul.items{list-style:none;margin:0;padding:0}
ul.items li{
  display:flex;align-items:center;gap:12px;background:var(--card-bg);border:1px solid var(--surface-border);
  border-radius:8px;padding:10px;margin-bottom:8px;transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
}
ul.items li:hover{ transform:translateY(-3px); box-shadow:0 10px 30px var(--shadow); background: linear-gradient(90deg, rgba(34,197,94,0.02), transparent) }
ul.items li img{width:50px;height:50px;border-radius:6px;object-fit:cover}
.btn-edit{background:#3b82f6;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer;border:none}
.btn-delete{background:#f43f5e;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer;border:none}

/* Botones bien en m√≥vil (no desfasados) */
@media (max-width:600px){
  ul.items li{ flex-wrap:wrap; }
  ul.items li > img{ flex:0 0 56px; }
  ul.items li > span{ flex:1 1 calc(100% - 70px); min-width:200px; }
  ul.items li .toggle-wrap{ flex:1 1 100%; order:3; justify-content:flex-start; }
  ul.items li .btn-edit,
  ul.items li .btn-delete{
    order:4;
    flex:1 1 calc(50% - 6px);
    padding:10px;
  }
}

/* inactive state */
ul.items li.inactive{opacity:.55;filter:grayscale(1)}
.badge-inactive{background:#ef4444;color:#fff;border-radius:6px;padding:2px 6px;font-size:11px;margin-left:6px}

/* Toggle-wrap alignment */
.toggle-wrap{margin-left:auto;display:flex;align-items:center;gap:6px}

/* Search (solo el de la p√°gina de productos) */
.search-wrapper{width:100%;max-width:920px;margin:14px 0;}
#search{
  width:100%;
  background:var(--search-bg);
  color:var(--text);
  border:2px solid var(--accent);
  border-radius:8px;
  padding:12px 16px;
  font-size:15px;
  transition:all .18s ease;
  background-image: url('data:image/svg+xml;utf8,<svg fill="%23ffffff" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M15.7 14.3l-3.4-3.4A6.5 6.5 0 1 0 1 6.5a6.5 6.5 0 0 0 10.4 5l3.4 3.4a1 1 0 0 0 1.4-1.4zM3 6.5A3.5 3.5 0 1 1 6.5 10 3.5 3.5 0 0 1 3 6.5z"/></svg>');
  background-repeat: no-repeat;
  background-position: 12px center;
  padding-left: 40px;
}
#search::placeholder{color:#94a3b8;font-weight:500}
#search:focus{outline:none;border-color:var(--accent-600);background:var(--input-bg);box-shadow:0 6px 20px rgba(16,185,129,0.08)}

/* Discounts grid */
.discount-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.discount-item{display:flex;align-items:center;justify-content:space-between;background:var(--input-bg);border:1px solid var(--surface-border);border-radius:8px;padding:10px}
.discount-item label{color:var(--text)}
.discount-actions{display:flex;gap:8px;margin-top:12px}
@media (max-width:800px){.discount-grid{grid-template-columns:1fr}}

	/* responsive */
@media (max-width:900px){

  #sidebar{
    position: fixed;
    top: 0;
    left: 0;
    height: 100dvh;           /* mejor en iPhone */
    width: 220px;
    max-width: 85vw;
    transform: translateX(-110%);
    transition: transform .25s ease, box-shadow .25s ease;
    overflow: auto;
  }

  #sidebar.open{
    transform: translateX(0);
  }

  .app{
    padding-left: 0;
  }

  #mainContent{
    padding: 16px;
  }
}

html, body{
  max-width: 100%;
  overflow-x: hidden;
}

  /* Bot√≥n Cerrar sesi√≥n visible SOLAMENTE en m√≥vil y fijo abajo */
  #logoutBtn{
    display:flex;
    position:sticky;
    bottom:0;
    width:100%;
    margin:0;
    border-radius:0;
    padding:12px;
    background:#f43f5e;
    color:#fff;
    font-weight:700;
    border:none;
    align-items:center;
    justify-content:center;
    z-index:1;
    box-shadow:0 -4px 12px rgba(0,0,0,.2);
  }

  /* margen inferior para que el contenido no quede oculto por el bot√≥n */
  #sidebarMenu{ padding-bottom:72px; }
}

	/* small screens */
	@media (max-width:520px){
	  .form-container{width:92%}
	  #toggleSidebarBtn{padding:8px 10px}
	  .header-left .header-title{font-size:16px}
	  #welcomeMessage{font-size:12px}
	  .btn-edit,.btn-delete{padding:10px}
	}

	/* global transitions */
	button,input,select,textarea,a{transition:all .15s ease}

	/* Capa semitransparente al abrir sidebar en m√≥vil */
	@media (max-width:900px){
	  body.sidebar-open::after{
		content:"";
		position:fixed;inset:0;
		background:rgba(0,0,0,.35);
		z-index:80; /* debajo del sidebar (90) y encima del resto */
	  }
	}

	/* ===== FIX MOBILE HEADERS CATEGORIAS ===== */
	@media (max-width:600px){

	  .category-section > div { /* header */
		flex-direction: column !important;
		align-items: stretch !important;
		gap: 8px;
	  }

	  .category-section h3{
		font-size:16px;
	  }

	  /* contenedor toggle */
	  .toggle-wrap{
		width:100%;
		justify-content:space-between;
	  }

	  /* bot√≥n limpiar */
	  .clear-btn{
		width:100%;
		padding:10px !important;
		font-size:13px;
	  }
	}
	/* ===== FIX REAL MOBILE OVERFLOW ===== */
	@media (max-width:600px){
	
	  #mainContent{
	    padding:12px !important;
	  }
	
	  .card{
	    width:100% !important;
	    max-width:100% !important;
	    margin:0 !important;
	  }
	
	  input, select, textarea{
	    max-width:100% !important;
	  }
	
	}
	
	/* ===== BLOQUEO SCROLL LATERAL REAL ===== */
	html, body{
	  overflow-x: hidden;
	  width: 100%;
	  max-width: 100%;
	}
	
	/* evita que elementos se pasen del viewport */
	*{
	  max-width: 100vw;
	}
	
	.categoria-header{
	  display:flex;
	  align-items:center;
	  gap:8px;
	  padding:6px 12px;
	  background:#242423;
	  border-radius:999px;
	  cursor:pointer;
	  transition:0.25s ease;
	  margin-bottom:6px;
	  width:100%;
	  max-width:100%;
	  overflow:hidden; /* üî• CLAVE */
	}
	
	/* MOBILE */
	@media (max-width:600px){
	
	  .categoria-header{
	    border-radius:12px;
	    flex-wrap:wrap;
	    justify-content:flex-start;
	  }
	
	  /* botones debajo en mobile */
	  .toggle-wrap,
	  .clear-btn{
	    width:100%;
	  }
	
	}
	
	.toggle-wrap{
	  flex-shrink:0;
	  max-width:100%;
	}
	
	.categoria-header *{
	  max-width:100%;
	}
	
	.cat-left{
	  display:flex;
	  align-items:center;
	  gap:8px;
	  flex:1;
	  min-width:0;
	}
	
	.cat-left h3{
	  white-space:normal;
	  word-break:break-word;
	}
	
</style>
</head>
<body class="light"> <!-- modo claro por defecto -->

<!-- LOGIN -->
<div id="loginDiv">
  <form id="loginForm" class="form-container" aria-label="Formulario de login">
    <input type="text" id="username" placeholder="Usuario" required />
    <input type="password" id="password" placeholder="Contrase√±a" required />
    <label style="gap:8px;font-size:14px"><input type="checkbox" id="rememberMe"> Recordar sesi√≥n</label>
    <button type="submit">Ingresar</button>
  </form>
</div>

<!-- APP (oculto hasta login) -->
<div id="dashboardDiv" aria-hidden="true">
  <div class="header-container">
    <header>
      <div class="header-left">
        <div class="header-title">Admin ‚Äî Productos y Descuentos</div>
        <div id="welcomeMessage"></div>
      </div>

      <div class="header-controls">
        <!-- Bot√≥n de men√∫ para m√≥vil -->
        <button id="openSidebarBtn" class="icon-btn" title="Abrir men√∫" aria-label="Abrir men√∫">‚ò∞</button>

        <!-- Bot√≥n tema -->
        <button id="themeToggleBtn" class="icon-btn" title="Alternar modo" aria-label="Alternar modo">
          <span id="themeIcon">‚òÄÔ∏è</span>
          <span style="font-weight:600">Tema</span>
        </button>
      </div>
    </header>
  </div>

  <div class="app">
    <aside id="sidebar" aria-hidden="false">
      <div>
        <div id="sidebarTop">
          <button id="toggleSidebarBtn">‚ò∞</button>
        </div>
        <nav id="sidebarMenu">
        <ul>
		  <li data-section="productos" class="active">üßÄ <span class="menu-text">Productos</span></li>
		  <li data-section="descuentos">üí∏ <span class="menu-text">Descuentos</span></li>
		  <li data-section="sucursales">üè¨ <span class="menu-text">Sucursales</span></li>
		  <li data-section="promos">üè∑Ô∏è <span class="menu-text">Gesti√≥n de Promos</span></li>
		</ul>
        </nav>
      </div>
      <!-- üëá Solo se muestra en m√≥vil por CSS -->
      <button id="logoutBtn"><span>Cerrar sesi√≥n</span></button>
    </aside>

    <main id="mainContent" tabindex="0">
      <!-- contenido din√°mico -->
    </main>
  </div>
</div>

<script type="module">
/* ================== IMPORTS ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
  getFirestore, collection, doc, getDocs, getDoc, query, where, 
  onSnapshot, deleteDoc, addDoc, setDoc 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { 
  getStorage, ref as storageRef, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAou7COlKKf0mJCnwEefntTKVGI2cxxJrU",
  authDomain: "santa-roti.firebaseapp.com",
  projectId: "santa-roti",
  storageBucket: "santa-roti.firebasestorage.app",
  messagingSenderId: "66221970620",
  appId: "1:66221970620:web:53083ce7727ff85e6d2cb9",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------- Estado ---------- */
let currentUserLocal = null;
let currentCategories = [];
let unsubscribeProducts = null;
const DEFAULT_CATS = ['pizza','hamburguesa','papas','menu especial','extras'];
const slug = s => (s||'').toString().trim().toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

/* ================== Persistencia UI (theme & sidebar) ================== */
const THEME_KEY = 'adminThemePref';
const SIDEBAR_KEY = 'adminSidebarPref';

function readTheme(){ return localStorage.getItem(THEME_KEY) || 'light'; }
function writeTheme(v){ localStorage.setItem(THEME_KEY, v); }

function readSidebar(){ return localStorage.getItem(SIDEBAR_KEY) === 'collapsed'; }
function writeSidebar(collapsed){ localStorage.setItem(SIDEBAR_KEY, collapsed ? 'collapsed' : 'expanded'); }

/* ================== DOM ELEMENTS ================== */
const loginDiv = document.getElementById('loginDiv');
const dashboardDiv = document.getElementById('dashboardDiv');
const welcomeMessage = document.getElementById('welcomeMessage');
const sidebar = document.getElementById('sidebar');
const sidebarMenu = document.getElementById('sidebarMenu');
const mainContent = document.getElementById('mainContent');
const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
const logoutBtn = document.getElementById('logoutBtn');
const themeToggleBtn = document.getElementById('themeToggleBtn');
const themeIcon = document.getElementById('themeIcon');
const openSidebarBtn = document.getElementById('openSidebarBtn');

/* ========== Theme init ========== */
function applyTheme(theme){
  if(theme === 'light'){
    document.body.classList.add('light');
    document.body.classList.remove('dark');
    themeIcon.textContent = '‚òÄÔ∏è';
  } else {
    document.body.classList.remove('light');
    document.body.classList.add('dark');
    themeIcon.textContent = 'üåô';
  }
  writeTheme(theme);
}
applyTheme(readTheme());

themeToggleBtn.addEventListener('click', ()=>{
  const next = document.body.classList.contains('light') ? 'dark' : 'light';
  applyTheme(next);
});

/* ========== Sidebar init & behavior ========== */
function applySidebarState(collapsed){
  if(collapsed){
    sidebar.classList.add('collapsed');
    sidebar.setAttribute('aria-hidden','true');
  }else{
    sidebar.classList.remove('collapsed');
    sidebar.setAttribute('aria-hidden','false');
  }
  writeSidebar(collapsed);
}
applySidebarState(readSidebar());

toggleSidebarBtn.addEventListener('click', ()=>{
  if(window.matchMedia("(max-width:900px)").matches){
    const willOpen = !sidebar.classList.contains('open');
    sidebar.classList.toggle('open');
    document.body.classList.toggle('sidebar-open', willOpen);
  } else {
    sidebar.classList.toggle('collapsed');
    writeSidebar(sidebar.classList.contains('collapsed'));
  }
});

openSidebarBtn?.addEventListener('click', ()=>{
  if(window.matchMedia("(max-width:900px)").matches){
    sidebar.classList.add('open');
    document.body.classList.add('sidebar-open');
  } else {
    sidebar.classList.toggle('collapsed');
    writeSidebar(sidebar.classList.contains('collapsed'));
  }
});

// close mobile sidebar by clicking outside
document.addEventListener('click', (e)=>{
  if(window.matchMedia("(max-width:900px)").matches){
    if(!sidebar.classList.contains('open')) return;
    if(!sidebar.contains(e.target) && !toggleSidebarBtn.contains(e.target) && !openSidebarBtn.contains(e.target)){
      sidebar.classList.remove('open');
      document.body.classList.remove('sidebar-open');
    }
  }
});

/* ========== ORIGINAL AUTH (Users) CODE (sin tocar la l√≥gica) ========== */
document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  if(!username || !password) return alert("Complet√° usuario y contrase√±a");

  try{
    const q = query(collection(db, "Users"), where("username", "==", username));
    const qs = await getDocs(q);
    if(qs.empty) return alert("Usuario no encontrado");
    const user = qs.docs[0].data();
    if(user.password !== password) return alert("Contrase√±a incorrecta");

    const sess = JSON.stringify({username, local: user.local});
    (document.getElementById('rememberMe').checked ? localStorage : sessionStorage).setItem("session", sess);
    await showDashboard(user.username || username, user.local);
  }catch(err){
    console.error(err); alert("Error al iniciar sesi√≥n: "+err.message);
  }
});

document.addEventListener("DOMContentLoaded", async ()=>{
  const session = localStorage.getItem("session") || sessionStorage.getItem("session");
  if(session){
    const data = JSON.parse(session);
    await showDashboard(data.username, data.local);
  }
});

logoutBtn.addEventListener('click', ()=>{
  localStorage.removeItem("session");
  sessionStorage.removeItem("session");
  hideDashboard();
});

/* ========== Layout: sidebar menu navigation ========== */
sidebarMenu.addEventListener('click', (e)=>{
  const li = e.target.closest('li[data-section]'); if(!li) return;
  sidebarMenu.querySelectorAll('li').forEach(el=>el.classList.remove('active'));
  li.classList.add('active');
  const section = li.getAttribute('data-section');
  if(section==='productos') renderProductosPage();
  if(section==='descuentos') renderDescuentosPage();
  if(section==='sucursales') renderSucursalesPage();
  if(section==='promos') renderPromosPage();
});

/* ========== Dashboard show/hide (con fade) ========== */
async function showDashboard(username, local){
  // fade out login
  loginDiv.style.opacity = '0';
  loginDiv.style.transform = 'translateY(8px)';
  loginDiv.style.pointerEvents = 'none';
  setTimeout(()=>{
    loginDiv.style.display='none';
    dashboardDiv.classList.add('visible');
    dashboardDiv.setAttribute('aria-hidden','false');
  }, 180);

  welcomeMessage.textContent = `Bienvenido ${username}. Local: ${local}`;
  currentUserLocal = local;

  await initCategoriesFromLocal();
  // default: productos view
  renderProductosPage();

  // foco accesibilidad
  setTimeout(()=>{ mainContent.focus(); }, 350);
}
function hideDashboard(){
  dashboardDiv.classList.remove('visible');
  dashboardDiv.setAttribute('aria-hidden','true');
  setTimeout(()=>{
    dashboardDiv.style.display = 'block';
    loginDiv.style.display='flex';
    loginDiv.style.opacity='1';
    loginDiv.style.transform='translateY(0)';
    loginDiv.style.pointerEvents='auto';
  }, 220);
  currentUserLocal = null;
  currentCategories = [];
  if(unsubscribeProducts){unsubscribeProducts(); unsubscribeProducts=null;}
}

/* ========== Categor√≠as din√°micas ========== */
async function initCategoriesFromLocal(){
  const key = slug(currentUserLocal);
  const ref = doc(db, 'locals', key);
  const snap = await getDoc(ref);
  if(snap.exists()){
    const cats = Array.isArray(snap.data().categories) ? snap.data().categories : [];
    currentCategories = cats.length ? cats : DEFAULT_CATS;
  }else{
    currentCategories = DEFAULT_CATS;
  }
  onSnapshot(ref, d=>{
    if(!d.exists()) return;
    const cats = Array.isArray(d.data().categories) ? d.data().categories : [];
    const next = cats.length ? cats : DEFAULT_CATS;
    if(JSON.stringify(next)!==JSON.stringify(currentCategories)){
      currentCategories = next;
      const active = sidebarMenu.querySelector('li.active')?.getAttribute('data-section');
      if(active==='productos') renderProductosPage();
      if(active==='descuentos') renderDescuentosPage();
    }
  });
}

/* ========================== VISTA: PRODUCTOS ========================== */
function renderProductosPage(){
  if(unsubscribeProducts){unsubscribeProducts(); unsubscribeProducts=null;}

  mainContent.innerHTML = `
    <div class="section card">
      <h2 style="margin:0 0 8px 0">Agregar / Editar Producto</h2>
      <form id="productForm">
        <input type="hidden" id="editId" />
        <label class="field" for="name">Nombre</label>
        <input id="name" placeholder="Ej: Pizza Muzza" required />

        <label class="field" for="desc">Descripci√≥n</label>
        <input id="desc" placeholder="Salsa, muzza, aceitunas" required />

        <label class="field" for="price">Precio</label>
        <input id="price" type="number" placeholder="5000" required />

        <label class="field" for="position">Orden (1..n)</label>
        <input id="position" type="number" min="1" placeholder="1" />

        <label class="field" for="productDiscount">Descuento del producto (%)</label>
        <input id="productDiscount" type="number" min="0" max="100" step="1" placeholder="0" />

        <label class="field" for="img">Imagen</label>
        <input id="img" type="file" accept="image/*" />
        <img id="imgPreview" src="https://via.placeholder.com/150x100?text=Sin+imagen" alt="Vista previa"/>

        <label class="field" for="category">Categor√≠a</label>
        <select id="category" required></select>

        <!-- Estado -->
        <label class="active-check">
		  <input type="checkbox" id="isActive" checked>
		  <span>Producto activo</span>
		</label>

        <div class="actions-row">
          <button class="primary" id="submitBtn" type="submit">Guardar producto</button>
          <button class="secondary" id="cancelEditBtn" type="button" style="display:none">Cancelar edici√≥n</button>
        </div>
      </form>
    </div>

    <div class="section card">
      <div class="actions-row" style="justify-content:space-between;align-items:center;width:100%">
        <h2 style="margin:0">Productos existentes</h2>
        <div class="search-wrapper"><input id="search" placeholder="Buscar por nombre..." autocomplete="off"/></div>
      </div>
      <div id="productLists"></div>
    </div>
  `;

  const productForm = document.getElementById('productForm');
  const editIdInput = document.getElementById('editId');
  const nameInput = document.getElementById('name');
  const descInput = document.getElementById('desc');
  const priceInput = document.getElementById('price');
  const posInput = document.getElementById('position');
  const prodDiscInput = document.getElementById('productDiscount');
  const imgInput = document.getElementById('img');
  const imgPreview = document.getElementById('imgPreview');
  const catSelect = document.getElementById('category');
  const searchInput = document.getElementById('search');
  const productLists = document.getElementById('productLists');
  const isActiveInput = document.getElementById('isActive');

  // Select categor√≠as
  catSelect.innerHTML = `<option value="">Seleccionar categor√≠a</option>`;
  currentCategories.forEach(cat=>{
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = capitalize(cat);
    catSelect.appendChild(opt);
  });

  // Secciones por categor√≠a
  productLists.innerHTML = '';
  currentCategories.forEach(cat=>{
    const sec = document.createElement('div');
    sec.className='category-section';
    sec.dataset.cat = cat;

    const header = document.createElement('div');
	header.className = 'categoria-header';
	
	const arrow = document.createElement('span');
	arrow.textContent = '‚ñº';
	arrow.style.fontSize = '14px';

	header.appendChild(arrow);

    const title = document.createElement('h3');
    title.textContent = capitalize(cat);
    title.style.margin = '0';
	
    const toggleAll = document.createElement('input');
    toggleAll.type = 'checkbox';
    toggleAll.checked = getCatToggle(cat);
    toggleAll.title = 'Activar/Inactivar todos los productos de esta categor√≠a';

    toggleAll.addEventListener('change', async ()=>{
      const activar = toggleAll.checked;
      const confirmMsg = activar
        ? `¬øActivar todos los productos de "${capitalize(cat)}"?`
        : `¬øInactivar todos los productos de "${capitalize(cat)}"?`;
      if(!confirm(confirmMsg)){ toggleAll.checked = !activar; return; }

      try {
        const q = query(collection(db, 'productos'), where('local', '==', currentUserLocal), where('category', '==', cat));
        const qs = await getDocs(q);
        const updates = qs.docs.map(d => 
          setDoc(doc(db, 'productos', d.id), { active: activar, updatedAt: new Date() }, { merge: true })
        );
        await Promise.all(updates);
        setCatToggle(cat, activar);
        alert(`Productos de "${capitalize(cat)}" ${activar ? 'activados' : 'inactivados'}.`);
      } catch(err){
        console.error(err);
        alert('Error al actualizar productos: ' + err.message);
        toggleAll.checked = !activar;
      }
    });

	// contenedor check + label
	const toggleWrap = document.createElement('div');
	toggleWrap.style.display = 'inline-flex';
	toggleWrap.style.alignItems = 'center';
	toggleWrap.style.gap = '8px';
	toggleWrap.style.padding = '6px 12px';
	toggleWrap.style.borderRadius = '999px';
	toggleWrap.style.transition = '0.25s ease';

	// icono
	const statusIcon = document.createElement('span');
	statusIcon.style.fontSize = '14px';

	// texto
	const toggleLabel = document.createElement('span');
	toggleLabel.textContent = 'ACTIVAR / DESACTIVAR PRODUCTOS';
	toggleLabel.style.fontSize = '13px';
	toggleLabel.style.fontWeight = 'bold';

	// funci√≥n visual
	function updateToggleUI(){
	  if(toggleAll.checked){
		toggleWrap.style.background = '#1f3a2a';
		toggleWrap.style.color = '#7CFFB2';
		statusIcon.textContent = '‚úî';
	  } else {
		toggleWrap.style.background = '#3a1f1f';
		toggleWrap.style.color = '#FF9B9B';
		statusIcon.textContent = '‚úñ';
	  }
	}

	// estado inicial
	updateToggleUI();

	// cuando cambia
	toggleAll.addEventListener('change', updateToggleUI);

	toggleWrap.appendChild(statusIcon);
	toggleWrap.appendChild(toggleLabel);
	toggleWrap.appendChild(toggleAll);

	header.appendChild(title);
	header.appendChild(toggleWrap);

	// BOTON LIMPIAR DESCUENTOS
	const clearBtn = document.createElement('button');
	clearBtn.classList.add('clear-btn');
	clearBtn.textContent = 'LIMPIAR DESCUENTOS %';
	clearBtn.style.fontSize = '13px';
	clearBtn.style.fontWeight = 'bold';
	clearBtn.style.padding = '4px 8px';
	clearBtn.style.cursor = 'pointer';
	clearBtn.style.borderRadius = '6px';
	clearBtn.style.border = 'none';
	clearBtn.style.background = '#1f3a2a';
	clearBtn.style.color = '#7CFFB2';

	clearBtn.addEventListener('click', async (e)=>{
	  e.stopPropagation();

	  if(!confirm(`¬øLimpiar descuentos de ${capitalize(cat)}?`)) return;

	  try{
		const q = query(
		  collection(db,'productos'),
		  where('local','==',currentUserLocal),
		  where('category','==',cat)
		);

		const qs = await getDocs(q);

		const updates = qs.docs.map(d =>
		  setDoc(doc(db,'productos',d.id),
			{ discountPct:0, updatedAt:new Date() },
			{ merge:true }
		  )
		);

		await Promise.all(updates);
		alert('Descuentos limpiados');
	  }catch(err){
		alert(err.message);
	  }
	});

	header.appendChild(clearBtn);


    sec.appendChild(header);

    const list = document.createElement('ul');
    list.className = 'items';
    list.id = `list-${slug(cat)}`;
    sec.appendChild(list);
	let open = true;

	header.addEventListener('click', ()=>{
	  open = !open;
	  list.style.display = open ? '' : 'none';
	  arrow.textContent = open ? '‚ñº' : '‚ñ∂';
	});

	// evita que el checkbox dispare el plegado
	toggleAll.addEventListener('click', e => e.stopPropagation());

    productLists.appendChild(sec);
  });

  function setEditMode(on){
    document.getElementById('submitBtn').textContent = on ? 'Actualizar producto' : 'Guardar producto';
    document.getElementById('cancelEditBtn').style.display = on ? 'inline-flex' : 'none';
  }
  function resetForm(){
    productForm.reset();
    editIdInput.value='';
    imgPreview.src="https://via.placeholder.com/150x100?text=Sin+imagen";
    isActiveInput.checked = true;
    setEditMode(false);
  }
  imgInput.addEventListener('change', e=>{
    const f=e.target.files?.[0];
    if(!f){imgPreview.src="https://via.placeholder.com/150x100?text=Sin+imagen";return;}
    const r=new FileReader(); r.onload=ev=>imgPreview.src=ev.target.result; r.readAsDataURL(f);
  });
  document.getElementById('cancelEditBtn').addEventListener('click', resetForm);

  productForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = nameInput.value.trim();
    const desc = descInput.value.trim();
    const price = parseFloat(priceInput.value);
    const position = parseInt(posInput.value,10);
    const discountPct = parseInt(prodDiscInput.value,10);
    const category = catSelect.value;
    const active = !!isActiveInput.checked;
    if(!name||!desc||!price||!category) return alert('Complet√° los campos obligatorios');

    try{
      let imgUrl = '';
      const editId = editIdInput.value;
      if(imgInput.files?.[0]){
        const file=imgInput.files[0];
        const safe=file.name.replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
        const ref=storageRef(storage,`productos/${slug(currentUserLocal)}/${Date.now()}_${safe}`);
        await uploadBytes(ref,file);
        imgUrl = await getDownloadURL(ref);
      }else if(editId){
        const snap = await getDoc(doc(db,'productos',editId));
        if(snap.exists()) imgUrl = snap.data().img || '';
      }

      const productData = {
        name, desc, price, category,
        local: currentUserLocal,
        img: imgUrl,
        position: isNaN(position)?null:position,
        discountPct: isNaN(discountPct)?0:Math.max(0,Math.min(100,discountPct)),
        active,
        updatedAt: new Date()
      };

      if(editId){
        await setDoc(doc(db,'productos',editId), productData);
        alert('Producto actualizado');
      }else{
        await addDoc(collection(db,'productos'), { ...productData, createdAt: new Date() });
        alert('Producto agregado');
      }
      resetForm();
    }catch(err){
      console.error(err); alert('Error al guardar: '+err.message);
    }
  });

  // Snapshot productos
  const listsMap = {}; currentCategories.forEach(c=> listsMap[c]=document.getElementById(`list-${slug(c)}`));
  if(unsubscribeProducts){unsubscribeProducts();}
  unsubscribeProducts = onSnapshot(collection(db,'productos'), snap=>{
    Object.values(listsMap).forEach(ul=>{ if(ul) ul.innerHTML=''; });
    snap.forEach(d=>{
      const p=d.data();
      if(p.local !== currentUserLocal && slug(p.local)!==slug(currentUserLocal)) return;
      const cat = p.category?.toString();
      const ul = listsMap[cat]; if(!ul) return;

      const li = document.createElement('li');
      li.dataset.name = (p.name||'').toLowerCase();
      if(p.active===false){ li.classList.add('inactive'); }

      const img = document.createElement('img');
      img.src = p.img || 'https://via.placeholder.com/150x100?text=Sin+imagen';
      li.appendChild(img);

      const span = document.createElement('span');
      span.style.flex='1';
      span.innerHTML = `${p.name} ‚Äî ${p.desc} ‚Äî $${p.price}${
	  (p.discountPct||0)>0
		? ` <span style="background:#1f3a2a;color:#7CFFB2;font-weight:bold;padding:2px 8px;border-radius:6px;margin-left:6px;">-${p.discountPct}%</span>`
		: ''} ${p.active===false?'<span class="badge-inactive">Inactivo</span>':''}`;
      
	  li.appendChild(span);

      const toggleWrap = document.createElement('div');
      toggleWrap.className = 'toggle-wrap';
      const label = document.createElement('label');
      label.style.fontSize='12px';
      label.style.display='flex';
      label.style.alignItems='center';
      label.style.gap='6px';
      const chk = document.createElement('input');
      chk.type='checkbox';
      chk.checked = (p.active !== false);
      chk.addEventListener('change', async ()=>{
        try{
          await setDoc(doc(db,'productos',d.id), { active: chk.checked, updatedAt: new Date() }, { merge:true });
        }catch(err){
          alert('No se pudo actualizar: '+err.message);
          chk.checked = !chk.checked;
        }
      });
      label.appendChild(chk);
      label.appendChild(document.createTextNode('Activo'));
      toggleWrap.appendChild(label);
      li.appendChild(toggleWrap);

      const btnE = document.createElement('button');
      btnE.className='btn-edit'; btnE.textContent='Editar';
      btnE.onclick=()=>{
        nameInput.value = p.name||'';
        descInput.value = p.desc||'';
        priceInput.value = p.price||'';
        posInput.value = p.position??'';
        prodDiscInput.value = p.discountPct??0;
        catSelect.value = p.category||'';
        editIdInput.value = d.id;
        imgPreview.src = p.img || 'https://via.placeholder.com/150x100?text=Sin+imagen';
        isActiveInput.checked = (p.active !== false);
        setEditMode(true);
        productForm.scrollIntoView({behavior:'smooth'});
      };
      li.appendChild(btnE);

      const btnD = document.createElement('button');
      btnD.className='btn-delete'; btnD.textContent='Borrar';
      btnD.onclick=async()=>{ if(confirm(`¬øEliminar ${p.name}?`)) await deleteDoc(doc(db,'productos',d.id)); };
      li.appendChild(btnD);

      ul.appendChild(li);
    });

    applySearchFilter();
  });

  // B√∫squeda
  function applySearchFilter(){
    const q=(searchInput.value||'').toLowerCase().trim();
    document.querySelectorAll('#productLists .category-section').forEach(sec=>{
      const items = sec.querySelectorAll('li'); let visible=0;
      items.forEach(li=>{
        const show=!q || (li.dataset.name||'').includes(q);
        li.style.display = show ? '' : 'none'; if(show) visible++;
      });
      sec.style.display = q ? (visible ? '' : 'none') : '';
    });
  }
  searchInput.addEventListener('input', applySearchFilter);

  function capitalize(s){return (s||'').charAt(0).toUpperCase()+(s||'').slice(1);}
}

/* ========================== VISTA: DESCUENTOS ========================== */
function renderDescuentosPage(){
  mainContent.innerHTML = `
    <div class="section card">
      <h2 style="margin:0 0 10px 0">Descuentos por categor√≠a</h2>
      <div id="discountsGrid" class="discount-grid"></div>
      <div class="discount-actions">
        <button class="primary" id="saveDiscountsBtn">Guardar descuentos</button>
        <button class="secondary" id="clearDiscountsBtn">Limpiar descuentos</button>
      </div>
      <p class="muted" style="margin-top:8px;color:var(--muted)">
        Se actualiza en tiempo real ajustando el precio en el carrito de compras de tu Web.
      </p>
    </div>
  `;

  const grid = document.getElementById('discountsGrid');
  grid.innerHTML='';
  currentCategories.forEach(cat=>{
    const row=document.createElement('div');
    row.className='discount-item';
    row.innerHTML=`
      <label>${capitalize(cat)}</label>
      <input type="number" min="0" max="100" step="1" data-cat="${cat}"
        placeholder="%" style="width:90px;text-align:right;background:var(--input-bg);color:var(--text);border:1px solid var(--surface-border);border-radius:6px;padding:6px"/>
    `;
    grid.appendChild(row);
  });

  const key = slug(currentUserLocal);
  const ref = doc(db,'settings',`discounts_${key}`);

  onSnapshot(ref, snap=>{
    const data = snap.exists()? snap.data() : {};
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      const val = clamp(Number(data?.[cat]??0));
      if(document.activeElement!==el) el.value = val;
    });
  });

  document.getElementById('saveDiscountsBtn').onclick = async ()=>{
    const payload = { local: currentUserLocal };
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      payload[cat] = clamp(parseInt(el?.value??'0',10));
    });
    await setDoc(ref,payload,{merge:true});
    alert('Descuentos guardados');
  };
  document.getElementById('clearDiscountsBtn').onclick = async ()=>{
    const payload = { local: currentUserLocal };
    currentCategories.forEach(cat=> payload[cat]=0);
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      if(el) el.value=0;
    });
    await setDoc(ref,payload,{merge:true});
    alert('Descuentos limpiados (0%)');
  };

  function clamp(n){ n=isNaN(n)?0:n; return n<0?0:n>100?100:n; }
  function capitalize(s){return (s||'').charAt(0).toUpperCase()+(s||'').slice(1);}
}

/* ========================== VISTA: SUCURSALES ========================== */
function renderSucursalesPage(){
  mainContent.innerHTML = `
    <div class="section card">
      <h2>Sucursales</h2>

      <div style="
        margin-top:15px;
        display:flex;
        align-items:center;
        gap:12px;
      ">
        <span style="font-size:18px; font-weight:600;">
          ¬øTiene sucursales?
        </span>

        <input 
          type="checkbox" 
          id="hasBranches"
          style="width:22px; height:22px; cursor:pointer;"
        />
      </div>

      <div id="branchesForm" style="display:none; margin-top:15px;">
        
        <input type="hidden" id="editBranchId" />

        <label class="field">Nombre de la sucursal</label>
        <input id="branchName" placeholder="Ej: Sucursal Centro" />

        <label class="field">Direcci√≥n</label>
        <input id="branchAddress" placeholder="Calle 123" />

        <label class="field">Tel√©fono</label>
        <input id="branchPhone" placeholder="351-0000000" />

        <div class="actions-row" style="margin-top:12px;">
          <button id="saveBranchBtn" class="primary">Guardar</button>
          <button id="cancelBranchEditBtn" class="secondary" style="display:none;">Cancelar</button>
        </div>
      </div>

      <div class="section" style="margin-top:25px;">
        <h3>Listado de sucursales</h3>
        <ul id="branchesList" class="items"></ul>
      </div>
    </div>
  `;

  const chk = document.getElementById("hasBranches");
  const form = document.getElementById("branchesForm");
  const saveBtn = document.getElementById("saveBranchBtn");
  const cancelEditBtn = document.getElementById("cancelBranchEditBtn");
  const list = document.getElementById("branchesList");

  const editIdInput = document.getElementById("editBranchId");
  const nameInput = document.getElementById("branchName");
  const addressInput = document.getElementById("branchAddress");
  const phoneInput = document.getElementById("branchPhone");

  /* ========== Mostrar / ocultar formulario ========== */
  chk.addEventListener("change", () => {
    form.style.display = chk.checked ? "block" : "none";
  });

  /* ========== Reset formulario ========== */
  function resetBranchForm(){
    editIdInput.value = "";
    nameInput.value = "";
    addressInput.value = "";
    phoneInput.value = "";
    cancelEditBtn.style.display = "none";
    saveBtn.textContent = "Guardar";
  }

  cancelEditBtn.addEventListener("click", resetBranchForm);

  /* ========== Guardar o actualizar sucursal ========== */
  saveBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim();
    const address = addressInput.value.trim();
    const phone = phoneInput.value.trim();
    const editId = editIdInput.value;

    if (!name || !address || !phone) {
      return alert("Complete todos los campos");
    }

    try {
      if(editId){
        // actualizar
        await setDoc(
          doc(db, "Sucursales", editId),
          {
            name,
            address,
            phone,
            local: currentUserLocal,
            updatedAt: new Date()
          },
          { merge: true }
        );
        alert("Sucursal actualizada");
      } else {
        // agregar nueva
        await addDoc(collection(db, "Sucursales"), {
          local: currentUserLocal,
          name,
          address,
          phone,
          createdAt: new Date()
        });
        alert("Sucursal guardada");
      }

      resetBranchForm();

    } catch (err) {
      console.error(err);
      alert("Error al guardar sucursal: " + err.message);
    }
  });

  /* ========== Cargar listado de sucursales del local ========== */
  const q = query(
    collection(db, "Sucursales"),
    where("local", "==", currentUserLocal)
  );

  onSnapshot(q, (snap) => {
    list.innerHTML = "";
    snap.forEach((d) => {
      const s = d.data();
      const li = document.createElement("li");

      li.innerHTML = `
        <span style="flex:1;">
          <b>${s.name}</b><br>
          ${s.address}<br>
          ${s.phone}
        </span>
      `;

      // Bot√≥n Editar
      const editBtn = document.createElement("button");
      editBtn.className = "btn-edit";
      editBtn.textContent = "Editar";
      editBtn.onclick = () => {
        editIdInput.value = d.id;
        nameInput.value = s.name;
        addressInput.value = s.address;
        phoneInput.value = s.phone;

        saveBtn.textContent = "Actualizar";
        cancelEditBtn.style.display = "inline-flex";

        form.style.display = "block";
        chk.checked = true;

        form.scrollIntoView({ behavior: "smooth" });
      };

      // Bot√≥n Eliminar
      const delBtn = document.createElement("button");
      delBtn.className = "btn-delete";
      delBtn.textContent = "Eliminar";
      delBtn.onclick = async () => {
        if (confirm("¬øEliminar sucursal?")) {
          await deleteDoc(doc(db, "Sucursales", d.id));
        }
      };

      li.appendChild(editBtn);
      li.appendChild(delBtn);
      list.appendChild(li);
    });
  });
}
/* ========================== VISTA: PROMOS ========================== */
function renderPromosPage(){
  mainContent.innerHTML = `
  <div class="section card">
    <h2 style="margin:0 0 10px 0">Gesti√≥n de Promos</h2>

    <!-- AGRANDADO -->
    <div style="margin-top:12px;padding:12px;border:1px solid var(--surface-border);border-radius:10px;background:var(--input-bg)">
      <h3 style="margin:0 0 10px 0;font-size:15px;">Agrandado de Hamburguesas</h3>

      <label class="field">Activo</label>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <input id="upsellEnabled" type="checkbox" style="width:22px;height:22px;cursor:pointer;" />
        <span id="upsellStatus" style="font-weight:700;"></span>
      </div>

      <label class="field">Monto del agrandado (ARS)</label>
      <input id="upsellAmount" type="number" min="0" step="1" placeholder="3000" />

      <div class="actions-row" style="margin-top:12px;">
        <button class="primary" id="saveUpsellBtn">Guardar</button>
        <button class="secondary" id="resetUpsellBtn">Restablecer</button>
      </div>
    </div>

    <!-- CODIGOS PROMOCIONALES -->
	<div style="margin-top:20px;padding:12px;border:1px solid var(--surface-border);border-radius:10px;background:var(--input-bg)">
	  <h3 style="margin:0 0 10px 0;font-size:15px;">C√≥digos Promocionales</h3>

	  <label class="field">C√≥digo</label>
	  <input id="promoCodeInput" type="text" placeholder="Ej: SANTA10" />

	  <label class="field">Porcentaje de descuento (%)</label>
	  <input id="promoDiscountPct" type="number" min="0" max="100" step="1" placeholder="10" />

	  <label class="field">Categor√≠as aplicables</label>
	  <div id="promoCategoriesContainer" 
		style="max-height:140px;overflow:auto;
            padding:8px;border:1px solid var(--surface-border);
            border-radius:8px;background:var(--input-bg);
            display:flex;flex-direction:column;gap:6px;">
		</div>

	  <label class="field">Cantidad m√°xima de usos</label>
	  <input id="promoMaxUses" type="number" min="0" step="1" placeholder="100" />

	  <label class="field">Activar sistema de c√≥digos</label>
	  <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
		<input id="promoEnabled" type="checkbox" style="width:22px;height:22px;cursor:pointer;" />
		<span id="promoStatus" style="font-weight:700;"></span>
	  </div>

	  <div class="actions-row">
		<button class="primary" id="savePromoBtn">Guardar</button>
		<button class="secondary" id="resetPromoBtn">Restablecer</button>
	  </div>

	  <p style="margin-top:10px;color:var(--muted);font-size:13px;">
		El c√≥digo aplicar√° el descuento solo a las categor√≠as seleccionadas.
	  </p>
	</div>  
	`;

  const key = slug(currentUserLocal);
  const ref = doc(db,'settings',`upsell_${key}`);

  const enabledEl = document.getElementById('upsellEnabled');
  const statusEl  = document.getElementById('upsellStatus');
  const amountEl  = document.getElementById('upsellAmount');

  function paintStatus(){
    const on = !!enabledEl.checked;
    statusEl.textContent = on ? 'ACTIVO' : 'INACTIVO';
    statusEl.style.color = on ? '#7CFFB2' : '#FF9B9B';
  }
  enabledEl.addEventListener('change', paintStatus);
  paintStatus();

  // Carga en tiempo real
  const unsub = onSnapshot(ref, snap=>{
    const data = snap.exists() ? snap.data() : {};
    const enabled = data.enabled !== false;      // default activo
    const amount  = Number(data.amount ?? 3000); // default 3000

    if(document.activeElement !== enabledEl) enabledEl.checked = !!enabled;
    if(document.activeElement !== amountEl) amountEl.value = isNaN(amount) ? 3000 : Math.max(0, Math.round(amount));

    paintStatus();
  });

  document.getElementById('saveUpsellBtn').onclick = async ()=>{
    const payload = {
      local: currentUserLocal,
      enabled: !!enabledEl.checked,
      amount: Math.max(0, Math.round(Number(amountEl.value || 0))),
      updatedAt: new Date()
    };
    await setDoc(ref, payload, { merge:true });
    alert('Promo guardada');
  };

  document.getElementById('resetUpsellBtn').onclick = async ()=>{
    enabledEl.checked = true;
    amountEl.value = 3000;
    paintStatus();
    await setDoc(ref, { enabled:true, amount:3000, updatedAt:new Date() }, { merge:true });
    alert('Promo restablecida');
  };

  // Limpieza de snapshot si cambias de secci√≥n (opcional simple)
  // Guardamos la referencia en window para no acumular listeners
  window.__unsubPromos?.();
  window.__unsubPromos = unsub;
  
  /* ================= CODIGOS PROMOCIONALES ================= */

	const promoRef = doc(db,'settings',`promoCodes_${key}`);

	const promoCodeInput = document.getElementById('promoCodeInput');
	const promoMaxUses = document.getElementById('promoMaxUses');
	const promoEnabled = document.getElementById('promoEnabled');
	const promoStatus = document.getElementById('promoStatus');
	const promoCategoriesSelect = document.getElementById('promoCategories');
	const promoDiscountPct = document.getElementById('promoDiscountPct');

	// llenar select con categor√≠as din√°micas del local
	const promoCategoriesContainer = document.getElementById('promoCategoriesContainer');
	promoCategoriesContainer.innerHTML = '';

	if (Array.isArray(currentCategories)) {
	  currentCategories.forEach(cat=>{
	  const row = document.createElement('div');
	  row.style.display = 'flex';
	  row.style.alignItems = 'center';
	  row.style.width = '100%';
	  row.style.padding = '6px 10px';
	  row.style.boxSizing = 'border-box';

	  const span = document.createElement('span');
	  span.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
	  span.style.flex = '1'; // ocupa todo el espacio

	  const checkbox = document.createElement('input');
	  checkbox.type = 'checkbox';
	  checkbox.value = cat;
	  checkbox.classList.add('promoCategoryCheck');
	  checkbox.style.width = '18px';
	  checkbox.style.height = '18px';
	  checkbox.style.margin = '0';

	  row.appendChild(span);
	  row.appendChild(checkbox);

	  promoCategoriesContainer.appendChild(row);
	});
	}
	
	function paintPromoStatus(){
	  const on = !!promoEnabled.checked;
	  promoStatus.textContent = on ? 'ACTIVO' : 'INACTIVO';
	  promoStatus.style.color = on ? '#7CFFB2' : '#FF9B9B';
	}
	promoEnabled.addEventListener('change', paintPromoStatus);
	paintPromoStatus();

	const unsubPromoCodes = onSnapshot(promoRef, snap=>{
	const data = snap.exists() ? snap.data() : {};

	  if(document.activeElement !== promoCodeInput)
		promoCodeInput.value = data.code || '';

	  if(document.activeElement !== promoMaxUses)
		promoMaxUses.value = data.maxUses || 0;

	  if(document.activeElement !== promoDiscountPct)
		promoDiscountPct.value = data.discountPct || 0;

	  if(document.activeElement !== promoEnabled)
		promoEnabled.checked = !!data.enabled;

	  // seleccionar categor√≠as
	  const selected = Array.isArray(data.categories) ? data.categories : [];
	  document.querySelectorAll('.promoCategoryCheck').forEach(cb=>{
	  cb.checked = selected.includes(cb.value);
	});

	  paintPromoStatus();
	});

	// Guardar
	document.getElementById('savePromoBtn').onclick = async ()=>{
	  const enabled = !!promoEnabled.checked;

	  const code = promoCodeInput.value.trim().toUpperCase();
	  const maxUses = Math.max(0, Math.round(Number(promoMaxUses.value || 0)));
	  const discountPct = Math.max(0, Math.min(100, Math.round(Number(promoDiscountPct.value || 0))));
	  const categories = [...document.querySelectorAll('.promoCategoryCheck:checked')]
		.map(cb => cb.value);

	  // üîπ SOLO validar si est√° activo
	  if (enabled) {
		if(!code) return alert("Ingres√° un c√≥digo v√°lido");
		if(categories.length === 0) return alert("Seleccion√° al menos una categor√≠a");
		if(discountPct <= 0) return alert("Ingres√° un porcentaje de descuento v√°lido");
	  }

	  await setDoc(promoRef,{
		local: currentUserLocal,
		code,
		enabled,
		discountPct,
		categories,
		maxUses,
		remainingUses: maxUses,
		updatedAt: new Date()
	  },{merge:true});

	  alert("Configuraci√≥n guardada");
	};

	// Restablecer
	document.getElementById('resetPromoBtn').onclick = async ()=>{
	  promoCodeInput.value = '';
	  promoMaxUses.value = 0;
	  promoDiscountPct.value = 0;
	  promoEnabled.checked = false;

	  [...promoCategoriesSelect.options].forEach(o=>o.selected=false);

	  paintPromoStatus();

	  await setDoc(promoRef,{
		code:'',
		maxUses:0,
		remainingUses:0,
		discountPct:0,
		categories:[],
		enabled:false,
		updatedAt:new Date()
	  },{merge:true});

	  alert("C√≥digo promocional restablecido");
	};

	// limpiar listener anterior si cambia de secci√≥n
	window.__unsubPromoCodes?.();
	window.__unsubPromoCodes = unsubPromoCodes;
}

/* ========================== Utilities: toggles por categor√≠a (localStorage) ========================== */
function _togglesKey() {
  return `catToggles:${slug(currentUserLocal || '')}`;
}
function _readToggles() {
  try { return JSON.parse(localStorage.getItem(_togglesKey())) || {}; }
  catch { return {}; }
}
function _writeToggles(map) {
  localStorage.setItem(_togglesKey(), JSON.stringify(map || {}));
}
function getCatToggle(cat) {
  const map = _readToggles();
  return (cat in map) ? !!map[cat] : true;
}
function setCatToggle(cat, value) {
  const map = _readToggles();
  map[cat] = !!value;
  _writeToggles(map);
}

/* ======== Mostrar/ocultar controles m√≥viles (solo men√∫) ======== */
function updateMobileControls(){
  const isMobile = window.matchMedia("(max-width:900px)").matches;
  // Mostramos el bot√≥n de abrir men√∫ en m√≥vil, en desktop tambi√©n sirve para expandir/colapsar
  openSidebarBtn.style.display = 'inline-flex';
}
window.addEventListener('resize', updateMobileControls);
updateMobileControls();

</script>
</body>
</html>
