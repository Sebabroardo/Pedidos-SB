<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äî Santa‚Äôs</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
  getFirestore, collection, doc, getDocs, getDoc, query, where, 
  onSnapshot, deleteDoc, addDoc, setDoc
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { 
  getStorage, ref as storageRef, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAou7COlKKf0mJCnwEefntTKVGI2cxxJrU",
  authDomain: "santa-roti.firebaseapp.com",
  projectId: "santa-roti",
  storageBucket: "santa-roti.firebasestorage.app",
  messagingSenderId: "66221970620",
  appId: "1:66221970620:web:53083ce7727ff85e6d2cb9",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// ELEMENTOS
const loginDiv = document.getElementById("loginDiv");
const dashboardDiv = document.getElementById("dashboardDiv");
const logoutBtn = document.getElementById("logoutBtn");
const welcomeMessage = document.getElementById("welcomeMessage");

// Panel de descuentos por categor√≠a
const discountPanel = document.querySelector('.discount-panel');
const CATEGORIES = ['pizza','hamburguesa','papas','menu especial','extras'];

const searchInput = document.getElementById('search'); // buscador
let currentUserLocal = null;

// --- DASHBOARD ---
async function showDashboard(username, local){
  loginDiv.style.display = "none";
  dashboardDiv.style.display = "flex";
  welcomeMessage.style.display = "block";
  discountPanel.style.display = "flex";
  logoutBtn.style.display = "block";
  welcomeMessage.textContent = `Bienvenido ${username}. Local asignado: ${local}`;
  currentUserLocal = local;
  renderDiscountInputs();   // inputs num√©ricos por categor√≠a
  filterProductsByLocal();
  loadDiscounts();          // sync en tiempo real
}

function hideDashboard(){
  loginDiv.style.display = "flex";
  dashboardDiv.style.display = "none";
  welcomeMessage.style.display = "none";
  discountPanel.style.display = "none";
  logoutBtn.style.display = "none";
  currentUserLocal = null;
}

// --- LOGIN ---
document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  const rememberMe = document.getElementById("rememberMe").checked;

  if(!username || !password) return alert("Todos los campos son obligatorios");

  try {
    const usersRef = collection(db, "Users");
    const q = query(usersRef, where("username", "==", username));
    const querySnapshot = await getDocs(q);

    if(querySnapshot.empty) return alert("Usuario no encontrado");

    const userDoc = querySnapshot.docs[0];
    const userData = userDoc.data();

    if(userData.password !== password) return alert("Contrase√±a incorrecta");

    const sess = JSON.stringify({username, local: userData.local});
    if(rememberMe) localStorage.setItem("session", sess);
    else sessionStorage.setItem("session", sess);

    showDashboard(userData.username, userData.local);

  } catch(err){
    console.error(err);
    alert("Error al iniciar sesi√≥n: "+err.message);
  }
});

// --- REVISAR SESI√ìN ---
document.addEventListener("DOMContentLoaded", ()=>{
  const session = localStorage.getItem("session") || sessionStorage.getItem("session");
  if(session){
    const data = JSON.parse(session);
    showDashboard(data.username, data.local);
  }
});

// --- LOGOUT ---
logoutBtn.addEventListener("click", ()=>{
  localStorage.removeItem("session");
  sessionStorage.removeItem("session");
  hideDashboard();
});

// Helpers edici√≥n
function setEditMode(enabled){
  const submitBtn = document.getElementById("submitBtn");
  const cancelBtn = document.getElementById("cancelEditBtn");
  submitBtn.textContent = enabled ? "Actualizar producto" : "Guardar producto";
  cancelBtn.style.display = enabled ? "inline-flex" : "none";
}

function resetForm(){
  const form = document.getElementById("productForm");
  form.reset();
  document.getElementById("editId").value = "";
  document.getElementById("imgPreview").src = "https://via.placeholder.com/150x100?text=Sin+imagen";
  setEditMode(false);
}

// --- PRODUCTOS (Alta/Edici√≥n) ---
document.getElementById("productForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  const desc = document.getElementById("desc").value.trim();
  const price = parseFloat(document.getElementById("price").value);
  const position = parseInt(document.getElementById("position").value, 10);
  const discountPct = parseInt(document.getElementById("productDiscount").value, 10);
  const category = document.getElementById("category").value;
  const imgFile = document.getElementById("img").files[0]; 
  const editIdField = document.getElementById("editId").value;

  try {
    let imgUrl = "";

    if (imgFile) {
      const safeName = imgFile.name.replace(/\s+/g, '_').replace(/[^\w.-]/g, '');
      const imgStorageRef = storageRef(storage, `productos/${Date.now()}_${safeName}`);
      await uploadBytes(imgStorageRef, imgFile);
      imgUrl = await getDownloadURL(imgStorageRef);
    } else if (editIdField) {
      const docSnap = await getDoc(doc(db, "productos", editIdField));
      if (docSnap.exists()) {
        imgUrl = docSnap.data().img || "";
      }
    }

    const productData = {
      name,
      desc,
      price,
      category,
      local: currentUserLocal,
      img: imgUrl,
      position: isNaN(position) ? null : position,
      discountPct: isNaN(discountPct) ? 0 : Math.max(0, Math.min(100, discountPct)),
      updatedAt: new Date()
    };

    if (editIdField) {
      await setDoc(doc(db, "productos", editIdField), productData);
      alert("Producto actualizado correctamente");
    } else {
      productData.createdAt = new Date();
      await addDoc(collection(db, "productos"), productData);
      alert("Producto agregado correctamente");
    }

    resetForm();
  } catch (err) {
    console.error("Error al guardar producto:", err);
    alert("‚ùå Error al guardar producto: " + err.message);
  }
});

// Cancelar edici√≥n
document.getElementById("cancelEditBtn").addEventListener("click", (e)=>{
  e.preventDefault();
  resetForm();
});

// --- VISTA PREVIA DE IMAGEN ---
document.getElementById("img").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = ev => document.getElementById("imgPreview").src = ev.target.result;
    reader.readAsDataURL(file);
  } else {
    document.getElementById("imgPreview").src = "https://via.placeholder.com/150x100?text=Sin+imagen";
  }
});

// --- LISTAS POR LOCAL + B√öSQUEDA EN VIVO ---
function filterProductsByLocal(){
  const productLists = {
    pizza: document.getElementById('pizzaList'),
    hamburguesa: document.getElementById('hamburguesaList'),
    papas: document.getElementById('papasList'),
    "menu especial": document.getElementById('menuEspecialList'),
    extras: document.getElementById('extrasList')
  };

  onSnapshot(collection(db, "productos"), snapshot => {
    Object.values(productLists).forEach(ul => ul.innerHTML = '');
    snapshot.forEach(d=>{
      const data = d.data();
      if(data.local !== currentUserLocal) return;

      const li = document.createElement('li');
      li.dataset.name = (data.name || '').toLowerCase();

      const imgElement = document.createElement('img');
      imgElement.src = data.img || "https://via.placeholder.com/150x100?text=Sin+imagen";
      imgElement.style.width = "50px";
      imgElement.style.height = "50px";
      imgElement.style.objectFit = "cover";
      imgElement.style.borderRadius = "6px";
      li.appendChild(imgElement);

      const span = document.createElement('span');
      const discountLabel = (Number(data.discountPct) || 0) > 0 ? ` ‚Äî Desc: ${data.discountPct}%` : '';
      span.textContent = `${data.name} ‚Äî ${data.desc} ‚Äî $${data.price}${discountLabel}`;
      li.appendChild(span);

      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.className = 'btn-edit';
      btnEdit.addEventListener('click', ()=>{
        // precarga de campos
        document.getElementById('name').value = data.name;
        document.getElementById('desc').value = data.desc;
        document.getElementById('price').value = data.price;
        document.getElementById('position').value = data.position ?? '';
        document.getElementById('productDiscount').value = data.discountPct ?? 0;
        document.getElementById('category').value = data.category;
        document.getElementById('editId').value = d.id;
        document.getElementById('imgPreview').src = data.img || "https://via.placeholder.com/150x100?text=Sin+imagen";
        // activar modo edici√≥n
        setEditMode(true);
        // scroll suave al formulario
        document.getElementById('productForm').scrollIntoView({behavior:'smooth', block:'start'});
      });

      const btnDelete = document.createElement('button');
      btnDelete.textContent = 'Borrar';
      btnDelete.className = 'btn-delete';
      btnDelete.addEventListener('click', async ()=>{
        if(confirm(`¬øEliminar ${data.name}?`)){
          await deleteDoc(doc(db, "productos", d.id));
        }
      });

      li.appendChild(btnEdit);
      li.appendChild(btnDelete);

      const cat = data.category?.trim().toLowerCase();
      if(productLists[cat]) productLists[cat].appendChild(li);
    });

    applySearchFilter(); // mantener filtro tras re-render
  });
}

// B√∫squeda en vivo
function applySearchFilter(){
  const q = (searchInput?.value || '').trim().toLowerCase();
  const sections = document.querySelectorAll('#productLists .category-section');

  sections.forEach(section => {
    const items = section.querySelectorAll('li');
    let visibleCount = 0;
    items.forEach(li => {
      const name = li.dataset.name || '';
      const visible = !q || name.includes(q);
      li.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });
    section.style.display = q ? (visibleCount ? '' : 'none') : '';
  });
}

if (searchInput) {
  searchInput.addEventListener('input', applySearchFilter);
}

// ============ DESCUENTOS POR CATEGOR√çA (INPUT NUM√âRICO) ============

function discountsDocRef(){
  return doc(db, "settings", "discounts_" + currentUserLocal);
}

function renderDiscountInputs(){
  const container = document.getElementById('discountsContainer');
  container.innerHTML = '';
  CATEGORIES.forEach(cat => {
    const wrapper = document.createElement('div');
    wrapper.className = 'discount-input-wrapper';
    wrapper.dataset.cat = cat;

    const label = document.createElement('label');
    label.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);

    const input = document.createElement('input');
    input.type = 'number';
    input.min = 0;
    input.max = 100;
    input.step = 1;
    input.placeholder = "%";
    input.className = 'discount-input';
    input.dataset.cat = cat;

    input.addEventListener('change', async ()=>{
      const val = clampPercent(parseInt(input.value,10));
      input.value = String(val);
      try {
        await setDoc(discountsDocRef(), { 
          local: currentUserLocal, 
          [cat]: val 
        }, { merge: true });
      } catch (err){
        console.error('Error guardando descuento:', err);
      }
    });

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    container.appendChild(wrapper);
  });
}

function clampPercent(n){
  n = isNaN(n) ? 0 : n;
  if (n < 0) return 0;
  if (n > 100) return 100;
  return n;
}

function loadDiscounts(){
  onSnapshot(discountsDocRef(), snap => {
    const data = snap.exists() ? snap.data() : {};
    CATEGORIES.forEach(cat => {
      const value = clampPercent(Number(data?.[cat] ?? 0));
      const input = document.querySelector(`.discount-input[data-cat="${cat}"]`);
      if (input) input.value = value;
    });
  });
}
</script>

<style>
body { font-family: Arial, sans-serif; background:#0f1115; color:#f5f7fb; display:flex; flex-direction:column; align-items:center; padding:20px;}
form { display:flex; flex-direction:column; gap:10px; background:#171a21; padding:20px; border-radius:12px; width:320px;}
input, select, button { padding:10px; border-radius:8px; border:none; font-size:14px;}
button { background:#22c55e; color:#fff; cursor:pointer; font-weight:bold;}
ul { list-style:none; padding:0; margin-top:10px; width:100%; max-width:500px; }
li { display:flex; justify-content:space-between; background:#171a21; padding:10px; border-radius:8px; margin-bottom:8px; align-items:center; gap:10px;}
li span { flex:1; }
.btn-delete { background:#f43f5e; color:#fff; }
.btn-edit { background:#3b82f6; color:#fff; }
#imgPreview { margin-top:10px; border-radius:8px; width:150px; height:100px; object-fit:cover; border:1px solid #333; }
#dashboardDiv { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 600px; position: relative; }

/* Panel de descuentos por categor√≠a */
.discount-panel { position: fixed; top: 20px; right: 20px; padding: 16px; background: #171a21; border-radius: 12px; width: 260px; display: none; flex-direction: column; gap: 10px; z-index: 1000; }
.discount-panel h3 { margin: 0 0 6px 0; font-size: 16px; }
.discount-input-wrapper { display:flex; justify-content:space-between; align-items:center; background:#11151c; padding:6px 10px; border-radius:8px; }
.discount-input-wrapper label { font-size:14px; color:#9aa3b2; }
.discount-input { width:60px; text-align:right; background:#171a21; color:#f5f7fb; border:1px solid #2a2f3a; border-radius:6px; padding:6px; }

/* Buscador */
.search-wrapper { width:100%; max-width:600px; margin:10px 0 0 0; }
#search { width:100%; background:#171a21; color:#f5f7fb; border:1px solid #2a2f3a; }
#search::placeholder { color:#9aa3b2; }

/* Bot√≥n cancelar edici√≥n */
.actions-row { display:flex; gap:8px; }
#cancelEditBtn { display:none; background:#9ca3af; color:#0f1115; }

#logoutBtn { position: fixed; bottom: 20px; right: 20px; padding:12px 25px; border-radius:12px; background:#f43f5e; color:#fff; border:none; cursor:pointer; font-weight:bold; display:none; }
</style>

</head>
<body>

<div id="loginDiv">
  <form id="loginForm" class="form-container">
    <input type="text" id="username" placeholder="Nombre de usuario" required>
    <input type="password" id="password" placeholder="Contrase√±a" required>
    <label><input type="checkbox" id="rememberMe"> Recordar sesi√≥n</label>
    <button type="submit">Ingresar</button>
  </form>
</div>

<div id="dashboardDiv">
  <h1>Panel Admin ‚Äî Agregar / Editar Producto</h1>
  <div id="welcomeMessage"></div>

  <form id="productForm">
    <input type="hidden" id="editId">
    <input type="text" id="name" placeholder="Nombre del producto" required>
    <input type="text" id="desc" placeholder="Descripci√≥n" required>
    <input type="number" id="price" placeholder="Precio" required>
    <input type="number" id="position" placeholder="Orden (1,2,3...)" min="1">
    <input type="number" id="productDiscount" placeholder="Descuento (%)" min="0" max="100" step="1">
    <input type="file" id="img" accept="image/*">
    <img id="imgPreview" src="https://via.placeholder.com/150x100?text=Sin+imagen" alt="Vista previa">
    <select id="category" required>
      <option value="">Seleccionar categor√≠a</option>
      <option value="pizza">Pizza</option>
      <option value="hamburguesa">Hamburguesa</option>
      <option value="papas">Papas</option>
      <option value="menu especial">Men√∫ especial</option>
      <option value="extras">Extras</option>
    </select>
    <div class="actions-row">
      <button type="submit" id="submitBtn">Guardar producto</button>
      <button id="cancelEditBtn">Cancelar edici√≥n</button>
    </div>
  </form>

  <!-- Buscador en tiempo real -->
  <div class="search-wrapper">
    <input type="text" id="search" placeholder="Buscar por nombre..." autocomplete="off">
  </div>

  <h2>Productos existentes</h2>
  <div id="productLists">
    <div class="category-section">
      <h3>Pizzas</h3>
      <ul id="pizzaList"></ul>
    </div>
    <div class="category-section">
      <h3>Hamburguesas</h3>
      <ul id="hamburguesaList"></ul>
    </div>
    <div class="category-section">
      <h3>Papas</h3>
      <ul id="papasList"></ul>
    </div>
    <div class="category-section">
      <h3>Men√∫ Especial</h3>
      <ul id="menuEspecialList"></ul>
    </div>
    <div class="category-section">
      <h3>Extras</h3>
      <ul id="extrasList"></ul>
    </div>
  </div>

  <!-- üî∏ Descuentos por categor√≠a -->
  <div class="discount-panel">
    <h3>Descuentos por categor√≠a</h3>
    <div id="discountsContainer"></div>
  </div>

  <button id="logoutBtn">Cerrar sesi√≥n</button>
</div>

</body>
</html>
