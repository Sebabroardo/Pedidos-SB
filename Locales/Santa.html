<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Santa Rotiseria ‚Äî Pedidos por WhatsApp</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#ffffff;
  --card:#f8f8f8;
  --muted:#4b5563;
  --text:#000000;
  --primary:#22c55e;
  --accent:#f43f5e;
  --ring:#d1d5db;
}
*{box-sizing:border-box}
html, body { margin:0; height:100%; font-family:STAATLICHES,sans-serif; background:url('../img/Fondo.png') repeat center center; background-size:auto; color:var(--text); }
.container{max-width:1100px;margin:0 auto;padding:24px}

/* Header */
header { background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); border-radius: 20px; padding: 18px; margin-bottom: 18px; display:flex; align-items:flex-start; justify-content:space-between; }
.brand-wrapper { display:flex; gap:12px; align-items:center; }
.logo {width:64px;height:64px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:none;}
.logo img {width:100%;height:100%;object-fit:contain;}
.brand-text h1{font-size:20px;margin:0}
.brand-text .tag a { display:flex; align-items:center; gap:4px; color:var(--muted); text-decoration:underline; font-size:18px; transition:color 0.3s ease;}
.brand-text .tag a svg { width:16px;height:16px; fill:#E1306C; transition: transform 0.3s ease, fill 0.3s ease;}
.brand-text .tag a:hover { color:red; }
.brand-text .tag a:hover svg { fill:red; transform: scale(1.2); }

/* HERO */
.hero{ padding:18px; border:1px solid var(--ring); border-radius:20px; display:grid; grid-template-columns:1.3fr .7fr; gap:18px; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); margin-bottom:14px;}
.hero .copy h2{font-size:20px;margin:0 0 8px}
.hero .copy p{margin:0;color:#000}
.hero .info{display:grid;gap:8px;align-content:start}
.pill{display:inline-flex;gap:8px;align-items:center;background:#f8f8f8;border:1px solid var(--ring);border-radius:999px;padding:8px 12px;font-size:12px;color:var(--muted)}

/* Layout 2 columnas */
.main{ display:grid; grid-template-columns: 2fr 1fr; gap:16px; }
@media (max-width:900px){ .main{ grid-template-columns: 1fr; } }

/* Categor√≠as desplegables (acorde√≥n) */
.category-btn{
  cursor:pointer;
  font-size:18px;
  margin:12px 0;
  display:flex;
  align-items:center;
  gap:6px;
  color:var(--text);
  font-weight:600;
  border:1px solid var(--ring);
  background: rgba(255,255,255,0.9);
  padding:8px 12px;
  border-radius:10px;
  transition: background 0.2s ease;
}
.category-btn:hover{ background: rgba(255,255,255,1); }

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:16px;
  margin-top:8px;
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:max-height .35s ease, opacity .2s ease;
  will-change:max-height;
}
.grid.show{ opacity:1; }

/* Cards de producto */
.card{background: rgba(255,255,255,0.95); border:1px solid var(--ring); border-radius:18px; padding:14px; backdrop-filter: blur(4px); display:flex; flex-direction:column; position:relative;}
.product{display:flex;flex-direction:column;gap:10px; height:100%}
.product .img{height:140px;border-radius:14px;background:#ffffff;border:1px dashed #d1d5db;display:grid;place-items:center;font-size:12px;color:#6b7280;overflow:hidden}
.product img{width:100%;height:100%;object-fit:cover;border-radius:14px}
.product h3{margin:0;font-size:16px}
.product p{margin:0;color:var(--muted);font-size:13px}
.price{font-weight:700}
.actions { display: flex; gap:6px; justify-content:flex-end; align-items:center; margin-top:auto; }
.actions button{width:28px;height:28px;border-radius:8px;border:1px solid var(--ring);background:#f8f8f8;color:#var(--text);cursor:pointer;}
.actions span{min-width:20px;text-align:center;display:inline-block;}

/* ‚úÖ Inactivos */
.card.product.inactive{filter:grayscale(1);opacity:.55}
.card.product .not-available{
  position:absolute;
  bottom:10px;left:10px;right:10px;
  background:rgba(239,68,68,.15);
  border:1px solid #ef4444;
  color:#ef4444;
  padding:6px 10px;
  border-radius:10px;
  font-weight:700;
  text-align:center;
}
.card.product.inactive .actions button{opacity:.4;pointer-events:none}

/* Carrito */
.cart{position:sticky;top:12px;display:grid;gap:10px;background: rgba(255,255,255,0.95); border:1px solid var(--ring); border-radius:18px; backdrop-filter: blur(4px);}
.cart h3{margin:0 0 6px}
.cart-list{display:grid;gap:8px;max-height:360px;overflow:auto;padding-right:6px}
.cart-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid var(--ring);border-radius:12px;background:#f8f8f8}
.cart-item .title{font-size:13px}
.cart-item .note{font-size:12px;color:#16a34a}
.cart-item button.remove-btn{background:#ef4444;color:#fff;border:none;border-radius:6px;padding:2px 6px;cursor:pointer}
.tot{display:flex;align-items:center;justify-content:space-between;font-weight:800}
.muted{color:var(--muted);font-size:12px}
.inputs{display:grid;gap:10px}
.inputs input, .inputs textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--ring);background:#f8f8f8;color:#000}
.inputs textarea{min-height:72px;resize:vertical}
.card img { width:100%; height:180px; object-fit:cover; border-top-left-radius:12px; border-top-right-radius:12px; display:block;}
footer { margin-top:22px; color: var(--muted); font-size:12px; text-align:center; background: rgba(255,255,255,0.9); padding:10px; border-radius:12px; }
.btn.primary { background: linear-gradient(180deg,#22c55e,#16a34a); border:none; color:#fff; font-size:15px; font-weight:600; padding:12px 14px; border-radius:999px; cursor:pointer; width:100%; }

@media (max-width:600px){
  header {flex-direction: column;align-items:center;padding:12px;gap:12px;}
  .brand-wrapper {flex-direction: column; gap:6px; align-items:center;}
  . {width:48px;height:48px;}
  .brand-text h1 {font-size:18px; text-align:center;}
  .brand-text .tag a {font-size:16px; text-align:center;}
  .pill {font-size:12px; padding:6px 10px; text-align:center;}
}

#discountInfo { display:none; font-size:14px; font-weight:600; color:#16a34a; background:#d1fae5; padding:6px 10px; border-radius:8px; margin-top:6px; align-items:center; gap:6px; }
#discountInfo::before { content:"üí∏"; }
#discountBreakdown { margin-top:4px; color:#16a34a; font-size:12px; display:none; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand-wrapper">
      <div class="logo"><img src="../img/logo.png" alt="Santa Rotiser√≠a"></div>
      <div class="brand-text">
        <h1>Santa</h1>
        <div class="tag">
          <a href="https://www.instagram.com/santa.roti" target="_blank">
            <svg viewBox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9S160.5 370.8 224.1 370.8 339 319.5 339 255.9 287.7 141 224.1 141zm0 186c-39.6 0-71.8-32.2-71.8-71.8s32.2-71.8 71.8-71.8 71.8 32.2 71.8 71.8-32.2 71.8-71.8 71.8zm146.4-194.3c0 14.9-12.1 27-27 27s-27-12.1-27-27 12.1-27 27-27 27 12.1 27 27zM398.8 80c-8.2-19.6-24.3-35.7-43.9-43.9C332.6 32 224 32 224 32S115.4 32 93.1 36.1c-19.6 8.2-35.7 24.3-43.9 43.9C32 115.4 32 224 32 224s0 108.6 17.1 131c8.2 19.6 24.3 35.7 43.9 43.9 22.3 4.1 130.9 4.1 130.9 4.1s108.6 0 131-17.1c19.6-8.2 35.7-24.3 43.9-43.9 4.1-22.3 4.1-130.9 4.1-130.9s0-108.6-17.1-131zM224 338c-45.5 0-82.4-36.9-82.4-82.4S178.5 173.2 224 173.2 306.4 210.1 306.4 255.6 269.5 338 224 338z"/></svg>
            Nuestro Instagram - Santa Rotiseria
          </a>
        </div>
      </div>
    </div>
    <div class="pill">‚è±Ô∏è Viernes, S√°bados y Domingos: 20:00 ‚Äì 23:30 ¬∑ üìç Cintra</div>
  </header>

  <!-- HERO -->
  <section class="hero">
    <div class="copy">
      <h2>Hac√© tu pedido online y confirmalo por WhatsApp</h2>
      <p>Eleg√≠ tu pedido, agregalo al carrito y presion√° ‚ÄúEnviar por WhatsApp‚Äù. Te llega el mensaje listo para confirmar con nuestra atenci√≥n.</p>
    </div>
    <div class="info">
      <div class="pill">üöö Retiro en local</div>
      <div class="pill">üí≥ Efectivo, D√©bito/Cr√©dito, QR</div>
    </div>
  </section>

  <div class="main">
    <!-- Cat√°logo din√°mico -->
    <section id="catalog" class="col-9"></section>

    <!-- Carrito -->
    <aside class="col-3">
      <div class="card cart">
        <h3>üõí Tu pedido</h3>
        <div class="cart-list" id="cartList"></div>
        <div class="tot"><span>Total</span><span id="total">$0</span></div>
        <div id="discountInfo" class="muted" style="font-size:12px;display:none;"></div>
        <div id="discountBreakdown" class="muted"></div>
        <div class="inputs">
          <input id="customerName" placeholder="Tu nombre"/>
          <textarea id="customerNotes" placeholder="Notas para la cocina (sin mayonesa, m√°s ketchup, etc.)"></textarea>
        </div>
        <button class="btn primary" id="whatsBtn">üì≤ Enviar pedido por WhatsApp</button>
        <div class="muted">Al hacer clic se abrir√° WhatsApp con el detalle de tu pedido para confirmar.</div>
      </div>
    </aside>
  </div>

  <footer>¬© <span id="year"></span> Santa ¬∑ Hecho con ‚ô•</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAou7COlKKf0mJCnwEefntTKVGI2cxxJrU",
  authDomain: "santa-roti.firebaseapp.com",
  projectId: "santa-roti",
  storageBucket: "santa-roti.firebasestorage.app",
  messagingSenderId: "66221970620",
  appId: "1:66221970620:web:53083ce7727ff85e6d2cb9",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= PROMO STATE ================= */

const promoRef = doc(db,'settings',`promoCodes_${slug(currentUserLocal)}`);

let promoState = {
  active: false,          // si est√° activo en Firestore
  applied: false,         // si el cliente lo aplic√≥
  discountPct: 0,
  code: '',
  remainingUses: 0
};

const promoBox = document.getElementById('promoBox');
const promoInput = document.getElementById('clientPromoCode');
const promoMessage = document.getElementById('promoMessage');

onSnapshot(promoRef, snap => {

  if(!snap.exists()){
    promoBox.style.display = 'none';
    promoState.active = false;
    return;
  }

  const data = snap.data();

  if(data.enabled && data.remainingUses > 0){
    promoBox.style.display = 'block';

    promoState.active = true;
    promoState.discountPct = data.discountPct;
    promoState.code = data.code;
    promoState.remainingUses = data.remainingUses;

  } else {
    promoBox.style.display = 'none';
    promoState.active = false;
    promoState.applied = false;
  }

});

const LOCAL_NAME = "Santa"; // informativo
const LOCAL_KEY  = "santa"; // clave real usada en settings/locals
const state = { cart: {} };
const currency = new Intl.NumberFormat('es-AR',{ style:'currency', currency:'ARS', maximumFractionDigits:0 });

const slug = s => (s||'').toString().trim().toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
const title = s => (s||'').charAt(0).toUpperCase()+(s||'').slice(1);
const prettyLabel = (cat) => {
  const k = (cat||'').toLowerCase();
  if(k==='pizza') return 'Pizzas';
  if(k==='hamburguesa') return 'Hamburguesas';
  if(k==='papas') return 'Papas';
  if(k==='menu especial') return 'Men√∫ Especial';
  if(k==='extras') return 'Extras';
  return title(cat);
};

// ====== DESCUENTOS (solo por LOCAL_KEY) ======
let globalDiscount = 0;
let catDiscounts = {};

// ====== PROMO UPSIZE (Agrandado Hamburguesas) ======
let upsellEnabled = true;
let upsellAmount = 3000;

function clampMoney(n){
  n = Number(n);
  if (isNaN(n)) return 0;
  return Math.max(0, Math.round(n));
}

function clampPercent(n){ n=Number(n)||0; return n<0?0:n>100?100:n; }
function mapLower(d){
  const out={};
  Object.keys(d||{}).forEach(k=>{
    if (['local','_updatedAt','value'].includes(k)) return;
    out[(k||'').toLowerCase()] = Number(d[k] ?? 0);
  });
  return out;
}
function catKeyOf(product){ return (product.category || '').toString().trim().toLowerCase(); }
function getDiscountPercents(product){
  const key = catKeyOf(product);
  const prod = clampPercent(product.discountPct || 0);
  const cat = clampPercent(catDiscounts[key] || 0);
  const anyCat = Object.values(catDiscounts||{}).some(v=>Number(v)>0);
  const baseOther = anyCat ? cat : clampPercent(globalDiscount || 0);
  const combined = clampPercent(prod + baseOther);
  return { prod, cat, global: anyCat ? 0 : baseOther, combined, usedCat: anyCat };
}

// per-categor√≠a (settings/discounts_{LOCAL_KEY})
onSnapshot(doc(db,"settings",`discounts_${LOCAL_KEY}`), snap=>{
  catDiscounts = snap.exists() ? mapLower(snap.data()) : {};
  renderCart();
});

// global (settings/discount_{LOCAL_KEY})
onSnapshot(doc(db,"settings",`discount_${LOCAL_KEY}`), snap=>{
  if (snap.exists()) {
    const v = Number((snap.data().value)||0);
    globalDiscount = isNaN(v) ? 0 : v;
  } else {
    globalDiscount = 0;
  }
  renderCart();
});

// upsell (settings/upsell_{LOCAL_KEY})
onSnapshot(doc(db,"settings",`upsell_${LOCAL_KEY}`), snap=>{
  if(snap.exists()){
    const data = snap.data();
    upsellEnabled = data.enabled !== false; // default true
    upsellAmount  = clampMoney(data.amount ?? 3000);
  }else{
    upsellEnabled = true;
    upsellAmount  = 3000;
  }
  renderCart(); // recalcular totales si cambia monto/estado
});

// ====== CATALOGO ======
const DEFAULT_ORDER = ['pizza','hamburguesa','papas','menu especial','extras'];
const catalogEl = document.getElementById('catalog');
let localCategories = null;
let currentCatOrder = [];
let openState = {};

onSnapshot(doc(db,'locals', LOCAL_KEY), snap=>{
  if(snap.exists()){
    const cats = Array.isArray(snap.data().categories) ? snap.data().categories : [];
    localCategories = cats.map(c => (c||'').toString().trim().toLowerCase());
  }else{
    localCategories = null;
  }
});

onSnapshot(collection(db,'productos'), snapshot => {
  const byCat = {};
  snapshot.docs.forEach(docu=>{
    const data = docu.data();
    const ok = (data.local === LOCAL_NAME) || (slug(data.local) === LOCAL_KEY);
    if(!ok) return;
    const id = docu.id;
    const catKey = (data.category || '').toString().trim().toLowerCase();
    if(!byCat[catKey]) byCat[catKey]=[];
    byCat[catKey].push({ id, ...data });
  });

  let order = [];
  if (Array.isArray(localCategories) && localCategories.length) {
    order = [...localCategories];
  } else {
    const present = Object.keys(byCat);
    const first = DEFAULT_ORDER.filter(c => present.includes(c));
    const rest  = present.filter(c => !DEFAULT_ORDER.includes(c)).sort();
    order = [...first, ...rest];
  }

  if (!catalogEl.children.length || JSON.stringify(order) !== JSON.stringify(currentCatOrder)) {
    rebuildCatalog(order);
    currentCatOrder = order;
  }

  if (order.length === 0) {
    catalogEl.innerHTML = `<div class="card" style="padding:16px;">Todav√≠a no hay productos cargados para Santa.</div>`;
    currentCatOrder = [];
    return;
  }

  order.forEach(cat=>{
    const grid = document.getElementById(`cat-${slug(cat)}`);
    if(!grid) return;
    grid.innerHTML = '';

    const items = (byCat[cat] || []).slice().sort((a,b)=>{
      const pa = Number(a.position ?? 999999);
      const pb = Number(b.position ?? 999999);
      if (pa !== pb) return pa - pb;
      return (a.name || '').localeCompare(b.name || '');
    });

    items.forEach(product=>{
      const uid = product.id;
      const isActive = product.active !== false; // default activo
      const card = document.createElement('div');
      card.className = `card product${isActive ? '' : ' inactive'}`;
      card.innerHTML = `
        <div class="img"><img src="${product.img || 'https://via.placeholder.com/240x180?text=Sin+imagen'}" alt="${product.name}"></div>
        <h3>${product.name}</h3>
        <p class="desc">${product.desc || ''}</p>
        <p class="price">${currency.format(product.price)}</p>
        ${isActive ? '' : '<div class="not-available">No Disponible</div>'}
        <div class="actions">
          <button class="btn-minus" data-id="${uid}">-</button>
          <span class="qty-display" data-id="${uid}">0</span>
          <button class="btn-plus" data-id="${uid}">+</button>
        </div>
      `;
      grid.appendChild(card);
    });

    if (grid.classList.contains('show')) {
      grid.style.maxHeight = 'none';
    }
  });
});

function rebuildCatalog(categories){
  const prevOpen = { ...openState };
  catalogEl.innerHTML = '';
  openState = {};

  categories.forEach(cat=>{
    const s = slug(cat);
    const id = `cat-${s}`;

    const btn = document.createElement('button');
    btn.className = 'category-btn';
    btn.dataset.target = id;
    const isOpen = !!prevOpen[id];
    btn.textContent = `${prettyLabel(cat)} ${isOpen ? '‚ñæ' : '‚ñ∏'}`;

    const grid = document.createElement('div');
    grid.id = id;
    grid.className = 'grid';

    btn.addEventListener('click', ()=>{
      const opened = grid.classList.contains('show');
      if (opened) {
        if (grid.style.maxHeight === 'none') {
          grid.style.maxHeight = grid.scrollHeight + 'px';
          void grid.offsetHeight;
        }
        grid.style.maxHeight = '0px';
        grid.classList.remove('show');
      } else {
        grid.classList.add('show');
        grid.style.maxHeight = grid.scrollHeight + 'px';
      }
      const openNow = !opened;
      btn.textContent = `${prettyLabel(cat)} ${openNow ? '‚ñæ' : '‚ñ∏'}`;
      openState[id] = openNow;
    });

    grid.addEventListener('transitionend', (ev)=>{
      if (ev.propertyName !== 'max-height') return;
      if (grid.classList.contains('show')) grid.style.maxHeight = 'none';
    });

    if (isOpen) {
      grid.classList.add('show');
      grid.style.maxHeight = 'none';
    }
    openState[id] = isOpen;

    catalogEl.appendChild(btn);
    catalogEl.appendChild(grid);
  });
}

// + / - (delegado en cat√°logo)
catalogEl.addEventListener('click', async (e)=>{
  const productId = e.target.dataset.id;
  if(!productId) return;
  const ref = doc(db,'productos',productId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const product = snap.data();
  const ok = (product.local === LOCAL_NAME) || (slug(product.local) === LOCAL_KEY);
  if(!ok) return;

  // bloquear interacci√≥n para inactivos
  if(product.active === false) return;

  if(e.target.classList.contains('btn-plus')){
    const uniqueId = productId + '-' + Date.now();
    state.cart[uniqueId] = { uid: uniqueId, product, idOriginal: productId, extra:false };
    renderCart(); updateCardQty(productId);
  }else if(e.target.classList.contains('btn-minus')){
    const key = Object.keys(state.cart).find(k => state.cart[k].idOriginal === productId);
    if(key){ delete state.cart[key]; renderCart(); updateCardQty(productId); }
  }
});

// ====== CARRITO ======
function renderCart() {
  const list = document.getElementById('cartList');
  list.innerHTML = '';
  let total = 0, totalSavings = 0;
  const savingsByKey = {};

  Object.values(state.cart).forEach(({ uid, product, extra })=>{
    const base = Number(product.price) || 0;
    const isBurger = (product.category||'').toLowerCase() === 'hamburguesa';
    const extraAdd = (upsellEnabled && isBurger && extra) ? upsellAmount : 0;

    const { prod, cat, global, combined, usedCat } = getDiscountPercents(product);
    const discountAmount = Math.round(base * (combined/100));
    const discountedLineTotal = (base - discountAmount) + extraAdd;
      
    total += discountedLineTotal;
    totalSavings += discountAmount;
  });

  // üî• DESCUENTO PROMO
  let promoDiscount = 0;

  if (promoState.applied) {
    promoDiscount = Math.round(total * (promoState.discountPct / 100));
    total -= promoDiscount;
  }

  total = Math.max(0, total);

  totalEl.textContent = "$" + total;
}

    if (prod > 0) savingsByKey[`prod:${product.name}`] = (savingsByKey[`prod:${product.name}`] || 0) + Math.round(base * (prod/100));
    const otherPct = usedCat ? cat : global;
    if (otherPct > 0) {
      const key = usedCat ? `cat:${catKeyOf(product)}` : 'global';
      savingsByKey[key] = (savingsByKey[key] || 0) + Math.round(base * (otherPct/100));
    }

    const detailParts = [];
    if (prod > 0) detailParts.push(`prod ${prod}%`);
    if (usedCat && cat > 0) detailParts.push(`cat ${cat}%`);
    if (!usedCat && global > 0) detailParts.push(`global ${global}%`);
    const detail = detailParts.length ? ` (desc. ${detailParts.join(' + ')})` : '';

    const row = document.createElement('div');
    row.className='cart-item';
    row.innerHTML=`
      <div>
        <div class="title">${product.name}${extra?' (Agrandado)':''} ‚Äî ${currency.format(discountedLineTotal)}</div>
        ${combined>0 ? `<div class="note">Ahorro ${currency.format(discountAmount)}${detail}</div>` : ''}
        ${
		  (isBurger && upsellEnabled)
			? `<label style="font-size:12px;">
				<input type="checkbox" class="extra-checkbox" data-id="${uid}" ${extra ? 'checked' : ''}>
				Agrandar Pedido +${currency.format(upsellAmount)}${combined > 0 ? ' (no se descuenta)' : ''}
			  </label>`
			: ''
		}
      </div>
      <button class="remove-btn" data-id="${uid}">X</button>
    `;
    list.appendChild(row);
  });

  list.querySelectorAll('.extra-checkbox').forEach(chk=>{
    chk.addEventListener('change', e=>{
      const uid = e.target.dataset.id;
      if(state.cart[uid]) state.cart[uid].extra = e.target.checked;
      renderCart();
      if(state.cart[uid]) updateCardQty(state.cart[uid].idOriginal);
    });
  });
  list.querySelectorAll('.remove-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const uid = e.target.dataset.id;
      const prodId = state.cart[uid]?.idOriginal;
      delete state.cart[uid];
      renderCart();
      if(prodId) updateCardQty(prodId);
    });
  });

  document.getElementById('total').textContent = currency.format(total);

  const discountInfo = document.getElementById('discountInfo');
  const breakdown = document.getElementById('discountBreakdown');

  if(totalSavings > 0){
    discountInfo.style.display = 'block';
    discountInfo.textContent = `¬°Descuentos aplicados! Ahorr√°s ${currency.format(totalSavings)}.`;
    const parts = Object.entries(savingsByKey)
      .filter(([_, amt]) => amt > 0)
      .map(([k, amt]) => {
        if (k.startsWith('prod:')) return `${k.replace('prod:','Producto ')}: ${currency.format(amt)}`;
        if (k.startsWith('cat:')) return `Categor√≠a ${k.replace('cat:','')}: ${currency.format(amt)}`;
        return `Global: ${currency.format(amt)}`;
      });
    breakdown.style.display = parts.length ? 'block' : 'none';
    breakdown.textContent = parts.join(' ¬∑ ');
  } else {
    discountInfo.style.display = 'none';
    breakdown.style.display = 'none';
    breakdown.textContent = '';
  }
}

function buildWhatsAppMessage() {
  const entries = Object.values(state.cart);
  if(entries.length===0){ alert('Agreg√° al menos 1 producto al carrito.'); return null; }
  const custName = document.getElementById('customerName').value.trim();
  if(!custName){  // üëà validaci√≥n obligatoria
    alert('Por favor, ingres√° tu nombre antes de continuar.');
    document.getElementById('customerName').focus();
    return null;
  }
  const notes = document.getElementById('customerNotes').value.trim();
  const lines = ['üßæ *Nuevo pedido ‚Äî Santa*',''];

  let total = 0, totalSavings = 0;
  const savingsByKey = {};

  entries.forEach(({ product, extra })=>{
    const base = Number(product.price) || 0;
    const isBurger = (product.category||'').toLowerCase() === 'hamburguesa';
	const extraAdd = (upsellEnabled && isBurger && extra) ? upsellAmount : 0;
    const { prod, cat, global, combined, usedCat } = getDiscountPercents(product);
    const discountAmount = Math.round(base * (combined/100));
    const discountedLineTotal = (base - discountAmount) + extraAdd;

    total += discountedLineTotal;
    totalSavings += discountAmount;

    if (prod > 0) savingsByKey[`prod:${product.name}`] = (savingsByKey[`prod:${product.name}`] || 0) + Math.round(base * (prod/100));
    const otherPct = usedCat ? cat : global;
    if (otherPct > 0) {
      const key = usedCat ? `cat:${catKeyOf(product)}` : 'global';
      savingsByKey[key] = (savingsByKey[key] || 0) + Math.round(base * (otherPct/100));
    }

    const detailParts = [];
    if (prod > 0) detailParts.push(`prod ${prod}%`);
    if (usedCat && cat > 0) detailParts.push(`cat ${cat}%`);
    if (!usedCat && global > 0) detailParts.push(`global ${global}%`);
    const detail = detailParts.length ? ` (${detailParts.join(' + ')})` : '';

    lines.push(`‚Ä¢ ${product.name}${extra?' (Agrandado)':''} ‚Äî ${currency.format(discountedLineTotal)}${detail}`);
  });

  lines.push('');
  if(totalSavings > 0){
    const parts = Object.entries(savingsByKey).filter(([_, a])=>a>0).map(([k,a])=>{
      if (k.startsWith('prod:')) return `${k.replace('prod:','Producto ')}: ${currency.format(a)}`;
      if (k.startsWith('cat:'))  return `Categor√≠a ${k.replace('cat:','')}: ${currency.format(a)}`;
      return `Global: ${currency.format(a)}`;
    });
    lines.push(`*Ahorro total:* ${currency.format(totalSavings)}`);
    if(parts.length) lines.push(`*Ahorro detallado:* ${parts.join(' ¬∑ ')}`);
  }
  lines.push(`*Total:* ${currency.format(total)}`);
  lines.push(`*Retiro:* Retira por Local, En calle Belgrano (https://www.google.com/maps?q=-32.307741,-62.650254)`);
  if(custName) lines.push(`*Nombre:* ${custName}`);
  if(notes) lines.push(`*Notas:* ${notes}`);
  lines.push('','Enviado desde la web de pedidos ‚úÖ');
  return lines.join('\n');
}

document.getElementById('whatsBtn').addEventListener('click', ()=>{
  const msg = buildWhatsAppMessage();
  if(!msg) return;
  const url = 'https://wa.me/+543537443959?text='+encodeURIComponent(msg);
  window.open(url,'_blank');
});

document.getElementById('applyPromoBtn').onclick = async () => {

  if(!promoState.active) return;

  const entered = promoInput.value.trim().toUpperCase();

  if(entered !== promoState.code){
    alert("C√≥digo inv√°lido");
    return;
  }

  if(promoState.remainingUses <= 0){
    alert("C√≥digo agotado");
    return;
  }

  const confirmApply = confirm(
    `¬øConfirmar aplicar ${promoState.discountPct}% de descuento?\n\nEsta acci√≥n descontar√° un uso del c√≥digo.`
  );

  if(!confirmApply) return;

  const newRemaining = promoState.remainingUses - 1;

  await updateDoc(promoRef,{
    remainingUses: newRemaining,
    enabled: newRemaining > 0
  });

  promoState.applied = true;
  promoState.remainingUses = newRemaining;

  promoMessage.style.color = "#7CFFB2";
  promoMessage.textContent = `Descuento aplicado (${promoState.discountPct}% OFF)`;

  renderCart();
};

function updateCardQty(uid){
  const count = Object.values(state.cart).filter(item => item.idOriginal === uid).length;
  const span = document.querySelector(`.qty-display[data-id="${uid}"]`);
  if(span) span.textContent = count;
}

document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>



