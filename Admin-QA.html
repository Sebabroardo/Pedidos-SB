<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin ‚Äî Productos y Descuentos por Local</title>

<style>
/* Base layout */
body{margin:0;font-family:Arial,sans-serif;background:#0f1115;color:#f5f7fb;min-height:100vh;display:flex;flex-direction:column;}
header{width:100%;padding:16px 20px;background:#0f1115;border-bottom:1px solid #222}
.header-title{font-size:18px;font-weight:700}
#welcomeMessage{font-size:13px;color:#9aa3b2;margin-top:4px}

/* Auth card */
#loginDiv{flex:1;display:flex;align-items:flex-start;justify-content:center;padding-top:60px}
.form-container{background:#171a21;padding:20px;border-radius:12px;width:320px;display:flex;flex-direction:column;gap:12px;box-shadow:0 4px 15px rgba(0,0,0,.3)}
.form-container input[type="text"],.form-container input[type="password"]{padding:10px;border-radius:8px;border:none;background:#11151c;color:#f5f7fb}
.form-container button{padding:10px;border:none;border-radius:8px;background:#22c55e;color:#fff;font-weight:bold;cursor:pointer}

/* App layout */
#dashboardDiv{display:none;flex:1;min-height:0}
.app{display:flex;height:calc(100vh - 66px);}

/* Sidebar */
#sidebar{width:220px;background:#171a21;color:#fff;display:flex;flex-direction:column;justify-content:space-between;box-shadow:2px 0 5px rgba(0,0,0,.2)}
#sidebarTop{display:flex;justify-content:flex-end;padding:10px}
#toggleSidebarBtn{background:#22c55e;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;color:#fff;font-weight:700}
#sidebarMenu{margin-top:8px}
#sidebarMenu ul{list-style:none;margin:0;padding:0}
#sidebarMenu li{padding:14px 18px;cursor:pointer;border-left:4px solid transparent;display:flex;align-items:center;gap:8px}
#sidebarMenu li:hover{background:#1f222a}
#sidebarMenu li.active{border-left-color:#22c55e;background:#1f222a}
#logoutBtn{margin:12px;border-radius:8px;background:#f43f5e;border:none;color:#fff;padding:10px;font-weight:700;cursor:pointer}

/* Collapsed */
#sidebar.collapsed{width:60px}
#sidebar.collapsed .menu-text{display:none}
#sidebar.collapsed #sidebarTop{justify-content:center}
#sidebar.collapsed #logoutBtn{display:flex;justify-content:center}
#sidebar.collapsed #logoutBtn span{display:none}

/* Main content */
#mainContent{flex:1;padding:20px;overflow:auto}

/* Forms / lists */
.card{background:#171a21;border:1px solid #2a2f3a;border-radius:12px;padding:16px}
.section{margin-bottom:18px}
label.field{font-size:12px;color:#9aa3b2;margin-top:6px;display:block}
input,select,button{border:none}
input,select{padding:10px;border-radius:8px;background:#11151c;color:#f5f7fb;width:100%}
button.primary{background:#22c55e;color:#fff;border-radius:8px;padding:10px;font-weight:700;cursor:pointer}
button.secondary{background:#9ca3af;color:#0f1115;border-radius:8px;padding:10px;font-weight:700;cursor:pointer}
.actions-row{display:flex;gap:8px;margin-top:8px}
#imgPreview{margin-top:10px;border-radius:8px;width:150px;height:100px;object-fit:cover;border:1px solid #333}

ul.items{list-style:none;margin:0;padding:0}
ul.items li{display:flex;align-items:center;gap:10px;background:#171a21;border:1px solid #2a2f3a;border-radius:8px;padding:10px;margin-bottom:8px}
ul.items li img{width:50px;height:50px;border-radius:6px;object-fit:cover}
.btn-edit{background:#3b82f6;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
.btn-delete{background:#f43f5e;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}

/* Dynamic category sections */
.category-section{margin-top:16px}
.category-section h3{margin:8px 0}

/* Discounts panel (as page) */
.discount-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.discount-item{display:flex;align-items:center;justify-content:space-between;background:#11151c;border:1px solid #2a2f3a;border-radius:8px;padding:10px}
.discount-item label{color:#f5f7fb}
.discount-actions{display:flex;gap:8px;margin-top:12px}
@media (max-width:800px){.discount-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="header-title">Admin ‚Äî Productos y Descuentos</div>
  <div id="welcomeMessage"></div>
</header>

<!-- LOGIN -->
<div id="loginDiv">
  <form id="loginForm" class="form-container">
    <input type="text" id="username" placeholder="Usuario" required />
    <input type="password" id="password" placeholder="Contrase√±a" required />
    <label style="gap:8px"><input type="checkbox" id="rememberMe"> Recordar sesi√≥n</label>
    <button type="submit">Ingresar</button>
  </form>
</div>

<!-- APP -->
<div id="dashboardDiv">
  <div class="app">
    <aside id="sidebar">
      <div>
        <div id="sidebarTop">
          <button id="toggleSidebarBtn">‚ò∞</button>
        </div>
        <nav id="sidebarMenu">
          <ul>
            <li data-section="productos" class="active">üßÄ <span class="menu-text">Productos</span></li>
            <li data-section="descuentos">üí∏ <span class="menu-text">Descuentos</span></li>
          </ul>
        </nav>
      </div>
      <button id="logoutBtn"><span>Cerrar sesi√≥n</span></button>
    </aside>

    <main id="mainContent">
      <!-- contenido din√°mico -->
    </main>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
  getFirestore, collection, doc, getDocs, getDoc, query, where, 
  onSnapshot, deleteDoc, addDoc, setDoc 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { 
  getStorage, ref as storageRef, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAou7COlKKf0mJCnwEefntTKVGI2cxxJrU",
  authDomain: "santa-roti.firebaseapp.com",
  projectId: "santa-roti",
  storageBucket: "santa-roti.firebasestorage.app",
  messagingSenderId: "66221970620",
  appId: "1:66221970620:web:53083ce7727ff85e6d2cb9",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------- Estado global ---------- */
let currentUserLocal = null;           // Users.local (nombre o key)
let currentCategories = [];            // locals/{localKey}.categories (o default)
let unsubscribeProducts = null;        // snapshot productos activo
const DEFAULT_CATS = ['pizza','hamburguesa','papas','menu especial','extras'];

const slug = s => (s||'').toString().trim().toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

/* ---------- DOM refs ---------- */
const loginDiv = document.getElementById('loginDiv');
const dashboardDiv = document.getElementById('dashboardDiv');
const welcomeMessage = document.getElementById('welcomeMessage');
const sidebar = document.getElementById('sidebar');
const sidebarMenu = document.getElementById('sidebarMenu');
const mainContent = document.getElementById('mainContent');
const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
const logoutBtn = document.getElementById('logoutBtn');

/* ---------- Auth simple con colecci√≥n Users ---------- */
document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  if(!username || !password) return alert("Complet√° usuario y contrase√±a");

  try{
    const usersRef = collection(db, "Users");
    const q = query(usersRef, where("username", "==", username));
    const qs = await getDocs(q);
    if(qs.empty) return alert("Usuario no encontrado");

    const userDoc = qs.docs[0];
    const user = userDoc.data();
    if(user.password !== password) return alert("Contrase√±a incorrecta");

    const sess = JSON.stringify({username, local: user.local});
    (document.getElementById('rememberMe').checked
      ? localStorage : sessionStorage).setItem("session", sess);

    await showDashboard(user.username || username, user.local);
  }catch(err){
    console.error(err);
    alert("Error al iniciar sesi√≥n: "+err.message);
  }
});

document.addEventListener("DOMContentLoaded", async ()=>{
  const session = localStorage.getItem("session") || sessionStorage.getItem("session");
  if(session){
    const data = JSON.parse(session);
    await showDashboard(data.username, data.local);
  }
});

logoutBtn.addEventListener('click', ()=>{
  localStorage.removeItem("session");
  sessionStorage.removeItem("session");
  hideDashboard();
});

/* ---------- Layout handlers ---------- */
toggleSidebarBtn.addEventListener('click', ()=> sidebar.classList.toggle('collapsed'));
sidebarMenu.addEventListener('click', (e)=>{
  const li = e.target.closest('li[data-section]');
  if(!li) return;
  sidebarMenu.querySelectorAll('li').forEach(el=>el.classList.remove('active'));
  li.classList.add('active');

  const section = li.getAttribute('data-section');
  if(section === 'productos') renderProductosPage();
  if(section === 'descuentos') renderDescuentosPage();
});

/* ---------- Dashboard ---------- */
async function showDashboard(username, local){
  loginDiv.style.display = 'none';
  dashboardDiv.style.display = 'block';
  welcomeMessage.textContent = `Bienvenido ${username}. Local: ${local}`;
  currentUserLocal = local;

  await initCategoriesFromLocal();   // set currentCategories + listener to changes
  renderProductosPage();             // default view
}
function hideDashboard(){
  dashboardDiv.style.display = 'none';
  loginDiv.style.display = 'flex';
  currentUserLocal = null;
  currentCategories = [];
  if(unsubscribeProducts){unsubscribeProducts(); unsubscribeProducts=null;}
}

/* ---------- CATEGOR√çAS DIN√ÅMICAS desde locals/{key} ---------- */
async function initCategoriesFromLocal(){
  const key = slug(currentUserLocal);
  const ref = doc(db, 'locals', key);
  const snap = await getDoc(ref);
  if(snap.exists()){
    const cats = Array.isArray(snap.data().categories) ? snap.data().categories : [];
    currentCategories = cats.length ? cats : DEFAULT_CATS;
  }else{
    currentCategories = DEFAULT_CATS;
  }
  // Resuscripci√≥n en vivo por si cambian
  onSnapshot(ref, d=>{
    if(!d.exists()) return;
    const cats = Array.isArray(d.data().categories) ? d.data().categories : [];
    const next = cats.length ? cats : DEFAULT_CATS;
    if(JSON.stringify(next)!==JSON.stringify(currentCategories)){
      currentCategories = next;
      // Re-render de la p√°gina actual
      const active = sidebarMenu.querySelector('li.active')?.getAttribute('data-section');
      if(active==='productos') renderProductosPage();
      if(active==='descuentos') renderDescuentosPage();
    }
  });
}

/* ============================================================
   VISTA: PRODUCTOS
============================================================ */
function renderProductosPage(){
  // Limpia snapshot si existe (se rehace m√°s abajo)
  if(unsubscribeProducts){unsubscribeProducts(); unsubscribeProducts=null;}

  mainContent.innerHTML = `
    <div class="section card">
      <h2 style="margin:0 0 8px 0">Agregar / Editar Producto</h2>
      <form id="productForm">
        <input type="hidden" id="editId" />
        <label class="field" for="name">Nombre</label>
        <input id="name" placeholder="Ej: Pizza Muzza" required />

        <label class="field" for="desc">Descripci√≥n</label>
        <input id="desc" placeholder="Salsa, muzza, aceitunas" required />

        <label class="field" for="price">Precio</label>
        <input id="price" type="number" placeholder="5000" required />

        <label class="field" for="position">Orden (1..n)</label>
        <input id="position" type="number" min="1" placeholder="1" />

        <label class="field" for="productDiscount">Descuento del producto (%)</label>
        <input id="productDiscount" type="number" min="0" max="100" step="1" placeholder="0" />

        <label class="field" for="img">Imagen</label>
        <input id="img" type="file" accept="image/*" />
        <img id="imgPreview" src="https://via.placeholder.com/150x100?text=Sin+imagen" alt="Vista previa"/>

        <label class="field" for="category">Categor√≠a</label>
        <select id="category" required></select>

        <div class="actions-row">
          <button class="primary" id="submitBtn" type="submit">Guardar producto</button>
          <button class="secondary" id="cancelEditBtn" type="button" style="display:none">Cancelar edici√≥n</button>
        </div>
      </form>
    </div>

    <div class="section card">
      <div class="actions-row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Productos existentes</h2>
        <input id="search" placeholder="Buscar por nombre..." style="max-width:280px"/>
      </div>
      <div id="productLists"></div>
    </div>
  `;

  // Refs
  const productForm = document.getElementById('productForm');
  const editIdInput = document.getElementById('editId');
  const nameInput = document.getElementById('name');
  const descInput = document.getElementById('desc');
  const priceInput = document.getElementById('price');
  const posInput = document.getElementById('position');
  const prodDiscInput = document.getElementById('productDiscount');
  const imgInput = document.getElementById('img');
  const imgPreview = document.getElementById('imgPreview');
  const catSelect = document.getElementById('category');
  const searchInput = document.getElementById('search');
  const productLists = document.getElementById('productLists');

  // Poblar select de categor√≠as
  catSelect.innerHTML = `<option value="">Seleccionar categor√≠a</option>`;
  currentCategories.forEach(cat=>{
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = capitalize(cat);
    catSelect.appendChild(opt);
  });

  // Crear skeleton de listas por categor√≠a
  productLists.innerHTML = '';
  currentCategories.forEach(cat=>{
    const sec = document.createElement('div');
    sec.className='category-section';
    sec.dataset.cat = cat;
    sec.innerHTML = `<h3>${capitalize(cat)}</h3><ul class="items" id="list-${slug(cat)}"></ul>`;
    productLists.appendChild(sec);
  });

  // Handlers del form
  function setEditMode(on){
    document.getElementById('submitBtn').textContent = on ? 'Actualizar producto' : 'Guardar producto';
    document.getElementById('cancelEditBtn').style.display = on ? 'inline-flex' : 'none';
  }
  function resetForm(){
    productForm.reset();
    editIdInput.value='';
    imgPreview.src = "https://via.placeholder.com/150x100?text=Sin+imagen";
    setEditMode(false);
  }
  imgInput.addEventListener('change', e=>{
    const file = e.target.files?.[0];
    if(!file){ imgPreview.src="https://via.placeholder.com/150x100?text=Sin+imagen"; return; }
    const r=new FileReader(); r.onload=ev=>imgPreview.src=ev.target.result; r.readAsDataURL(file);
  });
  document.getElementById('cancelEditBtn').addEventListener('click', resetForm);

  productForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = nameInput.value.trim();
    const desc = descInput.value.trim();
    const price = parseFloat(priceInput.value);
    const position = parseInt(posInput.value,10);
    const discountPct = parseInt(prodDiscInput.value,10);
    const category = catSelect.value;
    if(!name||!desc||!price||!category) return alert('Complet√° los campos obligatorios');

    try{
      let imgUrl = '';
      const editId = editIdInput.value;
      if(imgInput.files?.[0]){
        const file=imgInput.files[0];
        const safeName=file.name.replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
        const ref=storageRef(storage,`productos/${slug(currentUserLocal)}/${Date.now()}_${safeName}`);
        await uploadBytes(ref,file);
        imgUrl = await getDownloadURL(ref);
      }else if(editId){
        const snap = await getDoc(doc(db,'productos',editId));
        if(snap.exists()) imgUrl = snap.data().img || '';
      }

      const productData = {
        name, desc, price, category,
        local: currentUserLocal, // compat
        img: imgUrl,
        position: isNaN(position)?null:position,
        discountPct: isNaN(discountPct)?0:Math.max(0,Math.min(100,discountPct)),
        updatedAt: new Date()
      };

      if(editId){
        await setDoc(doc(db,'productos',editId), productData);
        alert('Producto actualizado');
      }else{
        await addDoc(collection(db,'productos'), { ...productData, createdAt: new Date() });
        alert('Producto agregado');
      }
      resetForm();
    }catch(err){
      console.error(err);
      alert('Error al guardar: '+err.message);
    }
  });

  // Snapshot de productos (seg√∫n categor√≠as din√°micas)
  const listsMap = {};
  currentCategories.forEach(c=> listsMap[c]=document.getElementById(`list-${slug(c)}`));

  if(unsubscribeProducts){unsubscribeProducts();}
  unsubscribeProducts = onSnapshot(collection(db,'productos'), snap=>{
    // limpiar
    Object.values(listsMap).forEach(ul=>{ if(ul) ul.innerHTML=''; });

    snap.forEach(d=>{
      const p = d.data();
      if(p.local !== currentUserLocal && slug(p.local)!==slug(currentUserLocal)) return;
      const cat = p.category?.toString();
      const ul = listsMap[cat];
      if(!ul) return;

      const li = document.createElement('li');
      li.dataset.name = (p.name||'').toLowerCase();

      const img = document.createElement('img');
      img.src = p.img || 'https://via.placeholder.com/150x100?text=Sin+imagen';
      li.appendChild(img);

      const span = document.createElement('span');
      span.style.flex='1';
      span.textContent = `${p.name} ‚Äî ${p.desc} ‚Äî $${p.price}${(p.discountPct||0)>0?` ‚Äî Desc ${p.discountPct}%`:''}`;
      li.appendChild(span);

      const btnE = document.createElement('button');
      btnE.className='btn-edit'; btnE.textContent='Editar';
      btnE.onclick = ()=>{
        document.getElementById('name').value = p.name||'';
        document.getElementById('desc').value = p.desc||'';
        document.getElementById('price').value = p.price||'';
        document.getElementById('position').value = p.position??'';
        document.getElementById('productDiscount').value = p.discountPct??0;
        document.getElementById('category').value = p.category||'';
        document.getElementById('editId').value = d.id;
        document.getElementById('imgPreview').src = p.img || 'https://via.placeholder.com/150x100?text=Sin+imagen';
        setEditMode(true);
        document.getElementById('productForm').scrollIntoView({behavior:'smooth'});
      };
      li.appendChild(btnE);

      const btnD = document.createElement('button');
      btnD.className='btn-delete'; btnD.textContent='Borrar';
      btnD.onclick = async ()=>{ if(confirm(`¬øEliminar ${p.name}?`)) await deleteDoc(doc(db,'productos',d.id)); };
      li.appendChild(btnD);

      ul.appendChild(li);
    });

    // Filtro de b√∫squeda
    applySearchFilter();
  });

  // B√∫squeda
  function applySearchFilter(){
    const q = (searchInput.value||'').toLowerCase().trim();
    document.querySelectorAll('#productLists .category-section').forEach(sec=>{
      const items = sec.querySelectorAll('li');
      let visible=0;
      items.forEach(li=>{
        const show = !q || (li.dataset.name||'').includes(q);
        li.style.display = show ? '' : 'none';
        if(show) visible++;
      });
      sec.style.display = q ? (visible? '':'none') : '';
    });
  }
  searchInput.addEventListener('input', applySearchFilter);

  function capitalize(s){return (s||'').charAt(0).toUpperCase()+(s||'').slice(1);}
}

/* ============================================================
   VISTA: DESCUENTOS
============================================================ */
function renderDescuentosPage(){
  mainContent.innerHTML = `
    <div class="section card">
      <h2 style="margin:0 0 10px 0">Descuentos por categor√≠a</h2>
      <div id="discountsGrid" class="discount-grid"></div>
      <div class="discount-actions">
        <button class="primary" id="saveDiscountsBtn">Guardar descuentos</button>
        <button class="secondary" id="clearDiscountsBtn">Limpiar descuentos</button>
      </div>
      <p class="muted" style="margin-top:8px;color:#9aa3b2">
        Los descuentos se guardan en <code>settings/discounts_{LOCAL_KEY}</code> donde <code>LOCAL_KEY</code> = <em>slug</em> de tu local.
      </p>
    </div>
  `;

  const grid = document.getElementById('discountsGrid');
  grid.innerHTML = '';
  currentCategories.forEach(cat=>{
    const row = document.createElement('div');
    row.className='discount-item';
    row.innerHTML = `
      <label>${capitalize(cat)}</label>
      <input type="number" min="0" max="100" step="1" data-cat="${cat}" placeholder="%" style="width:90px;text-align:right;background:#0f1115;color:#f5f7fb;border:1px solid #2a2f3a;border-radius:6px;padding:6px"/>
    `;
    grid.appendChild(row);
  });

  // Cargar snapshot
  const key = slug(currentUserLocal);
  const ref = doc(db,'settings',`discounts_${key}`);
  onSnapshot(ref, snap=>{
    const data = snap.exists()? snap.data() : {};
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      const val = clamp(Number(data?.[cat]??0));
      if(document.activeElement!==el) el.value = val;
    });
  });

  // Guardar / limpiar
  document.getElementById('saveDiscountsBtn').onclick = async ()=>{
    const payload = { local: currentUserLocal };
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      payload[cat] = clamp(parseInt(el?.value??'0',10));
    });
    await setDoc(ref,payload,{merge:true});
    alert('Descuentos guardados');
  };
  document.getElementById('clearDiscountsBtn').onclick = async ()=>{
    const payload = { local: currentUserLocal };
    currentCategories.forEach(cat=> payload[cat]=0);
    // UI -> 0
    currentCategories.forEach(cat=>{
      const el = grid.querySelector(`input[data-cat="${cat}"]`);
      if(el) el.value=0;
    });
    await setDoc(ref,payload,{merge:true});
    alert('Descuentos limpiados (0%)');
  };

  function clamp(n){ n=isNaN(n)?0:n; return n<0?0:n>100?100:n; }
  function capitalize(s){return (s||'').charAt(0).toUpperCase()+(s||'').slice(1);}
}
</script>
</body>
</html>
